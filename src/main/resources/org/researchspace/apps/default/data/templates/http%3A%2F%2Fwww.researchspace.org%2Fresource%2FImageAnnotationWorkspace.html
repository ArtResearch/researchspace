<mp-event-proxy id='refresh-image-list' on-event-source='image-editor' on-event-type='IIIFViewer.Updated'
                proxy-event-type='Component.TemplateUpdate' proxy-targets='["image-with-regions"]'
></mp-event-proxy>

<mp-event-proxy id='reset-form-on-image-update' on-event-source='image-editor' on-event-type='IIIFViewer.Updated'
                proxy-event-type='Component.TemplateUpdate' proxy-targets='["region-form"]'
></mp-event-proxy>

<mp-event-proxy id='add-new-manifest' on-event-source='set-action__km-add-frame' on-event-type='Dashboard.AddFrame'
                proxy-event-type='IIIFViewer.AddImagesForObject' proxy-targets='["image-editor"]'
></mp-event-proxy>

<div class="frame-imageAnnotationWorkspace__container">
      <div class="frame-imageAnnotationWorkspace__viewer">
        {{> @partial-block }}
      </div>

      <div class="frame-imageAnnotationWorkspace__formArea_bg"></div>

      <div class="frame-imageAnnotationWorkspace__formArea">

        <div class="frame-imageAnnotationWorkspace__formArea_content">

          <mp-event-target-template-render id='image-with-regions' template='{{> template}}'>
            <template id='template'>
                <div class="frame-imageAnnotationWorkspace__annotations">
                  <div>
                    {{#each objects}}
                      <h1 style="margin-left: 15px;">Observed on object &nbsp;<strong><semantic-link iri='{{objectIri}}'></semantic-link></strong>

                              <mp-event-trigger id='form-event-trigger' type='Component.TemplateUpdate' targets='["region-form"]'
                                              data='{"objectIri": "{{objectIri}}"}'>
                                <button style="margin-right: 5px;">new feature</button>
                              </mp-event-trigger>
                      </h1>

                      <semantic-query
                          query='
                            SELECT DISTINCT ?region ?objectIri {
                              <{{objectIri}}> crm:P138i_has_representation ?image .
                              ?region crmdig:L49_is_primary_area_of ?image .

                              FILTER NOT EXISTS {
                                ?feature crm:P138i_has_representation ?region .
                              }
                              BIND(<{{objectIri}}> as ?objectIri) .
                            }
                          '
                          template='{{> regionsWithoutFeature}}'
                      >
                        <template id='regionsWithoutFeature'>
                          <div>
                            <p>Regions without features<p/>
                            <ul>
                            {{#each bindings}}
                              <li>
                                <semantic-link iri='{{region.value}}'></semantic-link>
                              <mp-event-trigger id='form-event-trigger' type='Component.TemplateUpdate' targets='["region-form"]'
                                              data='{"region": "{{region.value}}", "objectIri": "{{objectIri.value}}"}'>
                                <button style="margin-right: 5px;">create associated feature</button>
                              </mp-event-trigger>

                              <button>Delete</button>
                              </li>
                            {{/each}}
                            </ul>
                          </div>
                        </template>
                      </semantic-query>


                      <semantic-query
                          query='
                            SELECT DISTINCT ?feature (SAMPLE(?r) AS ?region) (COUNT(?r) AS ?numberOfRegions) (<{{objectIri}}> as ?objectIri) {
                              ?feature crm:P56i_is_found_on <{{objectIri}}> .
                              OPTIONAL {
                                ?feature crm:P138i_has_representation ?r .
                              }
                            } 
                            GROUP BY ?feature
                          '
                          template='{{> features}}'
                      >
                        <template id='features'>
                          <div>
                            <p>Object features<p/>
                            <ul>
                            {{#each bindings}}
                              <li>
                                <semantic-link iri='{{feature.value}}'></semantic-link> <button>explore details</button>

                              <mp-event-trigger id='form-event-trigger' type='Component.TemplateUpdate' targets='["region-form"]'
                                              data='{"feature": "{{feature.value}}", "objectIri": "{{objectIri.value}}"}'>
                                <button style="margin-right: 5px;">edit</button>
                              </mp-event-trigger>

                              <button>Focus</button>
                              </li>
                            {{/each}}
                            </ul>
                          </div>
                        </template>
                      </semantic-query>

                    {{/each}}
                  </div>
                </div>
              </template>
          </mp-event-target-template-render>
          
          <mp-event-target-template-render id='region-form' template='{{> template}}'>
            <template id='template'>
              <div>
                {{#if feature}}
                  <div class="frame-imageAnnotationWorkspace__form-container">
                    <h1>Editing feature: &nbsp;<strong><semantic-link iri='{{feature}}'></semantic-link></strong></h1>
                    {{> rsp:ImageAnnotationForm edit=true}}
                  </div>
                {{else}}
                  {{#if region}}
                    <div class="frame-imageAnnotationWorkspace__form-container">
                      <h1>Creating feature represented by the region: &nbsp;<strong><semantic-link iri='{{region}}'></semantic-link></strong></h1>
                      {{> rsp:ImageAnnotationForm createFromRegion=true}}
                    </div>
                  {{else}}
                    {{#if objectIri}}
                      <div class="frame-imageAnnotationWorkspace__form-container">
                        <h1>Creating new feature for object: &nbsp;<strong><semantic-link iri='{{objectIri}}'></semantic-link></strong></h1>
                        {{> rsp:ImageAnnotationForm createWithoutRegion=true}}
                      </div>
                    {{/if}}
                  {{/if}}
                {{/if}}
              </div>
            </template>
          </mp-event-target-template-render>

        </div>

      </div>

  </div>
