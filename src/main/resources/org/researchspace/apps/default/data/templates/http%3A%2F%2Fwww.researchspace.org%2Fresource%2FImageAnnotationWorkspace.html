[[!--
 This template implements "Object observation through digital images" feature of the ResearchSpace.
 
 We assume that:
  * we are dealing with objects that are instances of `crm:E18_Physical_Thing` (or any subclass of it) 
  * every object has at least one image representation (crm:P138i_has_representation)
  * images (rso:EX_Digital_Image) are serverd from IIIF server
  * object's features are connected to the object with `crm:P56i_is_found_on` property (currently we are not checking for crm:P56_bears_feature !!!)
  * object feature can have image region (rso:EX_Digital_Image_Region) as a representation (crm:P138i_has_representation)
  * object feature can be:
      "Mark" - ?feature crm:P65_shows_visual_item/rdf:type crm:E37_Mark
      "Inscription" - ?feature crm:P65_shows_visual_item/rdf:type crm:E34_Inscription 
      "Subject" - ?feature crm:P128_carries/crm:P129_is_about ?about
      "Reference" - ?feature crm:P128_carries/crm:P67_refers_to ?reference 

 The UI consists of two main areas:
     +-------------------------------------------+
     |                         |                 |
     |                         |                 |
     |                         |                 |
     |                         |                 |
     |                         |  Objects with   |
     |       IIIF Viewer       |    Features     |
     |                         |                 |
     |                         |                 |
     |                         |                 |
     +-------------------------------------------+

 Left panel with IIIF Viewer and 
 Right panel that shows all objects from the manifest loaded in the IIIF Viewer together with corresponding features. 
--]]


[[!-- EVENTS --]]
[[!--
 Listen to `Dashboard.AddFrame` for "objectImageObservation" view. Here we assume that "objectImageObservation" view in the thinking frames is marked as "unique",
 which means that there can be only a single frame of this kind. So `Dashboard.AddFrame` is not going to add new frame, instead we define event-proxy to
 trigger `IIIFViewer.AddImagesForObject` on the active IIIF Viewer to add the object with corresponding images to the current viewer. 
 
 For this proxy to work `Dashboard.AddFrame` event trigger should also send "objectIri" field that is expected by the IIIF Viewer, the field value should be equal to "resourceIri" field that is expected by `rs-dashboard` component.
 
 As an example of corresponding event trigger see rsp:itemCardTemplateDefault.
--]]
<mp-event-proxy id='add-object-to-iiif-viewer' 
                on-event-type='Dashboard.AddFrame' on-event-data='{"viewId": "objectImageObservation"}'
                proxy-event-type='IIIFViewer.AddImagesForObject' proxy-targets='["image-editor"]'
></mp-event-proxy>

[[!-- 
 When list of images that can be shown in the IIIF Viewer is created or updated, it triggers `IIIFViewer.ManifestUpdated` event with list of objects and corresponding images in the event payload.
 
 We proxy this event to `image-with-regions` that represents right panel view with all objects and corresponding features. 
--]]
<mp-event-proxy id='refresh-image-list' on-event-source='image-editor' on-event-type='IIIFViewer.ManifestUpdated'
                proxy-event-type='Component.TemplateUpdate' proxy-targets='["image-with-regions"]'
></mp-event-proxy>

[[!-- 
 When new region is defined in the IIIF Viewer it triggers `IIIFViewer.RegionCreated`, when it happens we want to show feature creation wizard that is
 defined as a "back" panel of the `objects-panel` component. 
 
 We add to the event data `{"dontRefresh": true}` to not refresh feature form if it is already opened.
--]]
<mp-event-proxy id='refresh-image-list' on-event-source='image-editor' on-event-type='IIIFViewer.RegionCreated'
                proxy-event-type='TwoSidePanel.ShowBack' proxy-targets='["objects-panel"]' additional-data='{"dontRefresh": true}'
></mp-event-proxy>
[[!-- /EVENTS --]]


[[!-- INCLUDES --]]
[[#*inline "featureForm"]]
<!-- [[!--Please don't edit region's label or rdf:type through this form!!!!! --]]-->
  <semantic-form 
                 id='feature-creation-form'
                 post-action='event'
                 subject='{{#if edit}}{{feature}}{{/if}}'
                 new-subject-template='{{objectIri}}/E25_Man-Made_Feature/{{{{raw}}}}{{UUID}}{{{{/raw}}}}'
                 persistence='{"type": "sparql", "targetInsertGraphIri": "http://www.researchspace.org/ns/data-updates-graph-test"}'

                fields='[[
                 fieldDefinitions
                   label="http://www.w3.org/2000/01/rdf-schema#label"
                   P67i_is_referred_to_by_latehokusai_annotation="http://www.researchspace.org/pattern/P67i_is_referred_to_by_latehokusai_annotation"
                   classtype="http://www.researchspace.org/pattern/latehokusai_feature_type"
                   P138i_has_representation_latehokusai_representation="http://www.researchspace.org/pattern/P138i_has_representation_latehokusai_representation"
                   P65_shows_visual_item_latehokusai_annotation_inscription="http://www.researchspace.org/pattern/P65_shows_visual_item_latehokusai_annotation_inscription"
                   P128_carries_latehokusai_annotation_information="http://www.researchspace.org/pattern/P128_carries_latehokusai_annotation_information"
                   P65_shows_visual_item_latehokusai_annotation_mark="http://www.researchspace.oeg/pattern/P65_shows_visual_item_latehokusai_annotation_mark"
                   P130_shows_features_of_latehokusai_annotation="http://www.researchspace.org/pattern/P130_shows_features_of_latehokusai_annotation"
                   P128_carries_latehokusai_annotation_entity="http://www.researchspace.org/pattern/P128_carries_latehokusai_annotation_entity"
                   O8i_was_observed_by_latehokusai="http://www.researchspace.org/pattern/O8i_was_observed_by_latehokusai"
                   P56i_is_found_on_late_hokusai_feature="http://www.researchspace.org/pattern/P56i_is_found_on_late_hokusai_feature"
                   P129_is_about_latehokusai_annotation_subject="http://www.researchspace.org/pattern/P129_is_about_latehokusai_annotation_subject"
                   P67_refers_to_latehokusai_annotation_place="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_place"
                   P138i_has_representation_latehokusai_representation="http://www.researchspace.org/pattern/P138i_has_representation_latehokusai_representation"  
                ]]'
  >


    <div class="form-scrollable-area">
      <semantic-form-hidden-input for="P56i_is_found_on_late_hokusai_feature" default-value='{{objectIri}}'> </semantic-form-hidden-input>

      <semantic-form-select-input for="classtype" default-value='http://www.cidoc-crm.org/cidoc-crm/E25_Man-Made_Feature'> </semantic-form-select-input>

      {{#if regionIri}}
        <semantic-form-drag-and-drop-input  for="P138i_has_representation_latehokusai_representation" default-value='{{regionIri}}'></semantic-form-drag-and-drop-input>
      {{else}}
        <semantic-form-drag-and-drop-input  for="P138i_has_representation_latehokusai_representation"></semantic-form-drag-and-drop-input>
      {{/if}}

      {{#if createFromRegion}}
      <semantic-form-hidden-input for="label" default-value='{{featureType}}: {{regionLabel}}'> </semantic-form-hidden-input>
      {{else}}
      <semantic-form-text-input for="label"> </semantic-form-text-input>
      {{/if}}

      <semantic-form-checklist-input for='O8i_was_observed_by_latehokusai' type='checkbox'></semantic-form-checklist-input>

      {{#switch featureType}}
        {{#case "Inscription" break=true}}
      <semantic-form-composite-input
                                     for="P65_shows_visual_item_latehokusai_annotation_inscription" 
                                     new-subject-template="/E34_Inscription/{{{{raw}}}}{{UUID}}{{{{/raw}}}}" 
                                     fields='[[fieldDefinitions
                                        classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                        P190_has_symbolic_object_late_hokusai_annotation_symbolic="http://www.researchspace.org/pattern/P190_has_symbolic_object_late_hokusai_annotation_symbolic"
                                        P72_has_language_latehokusai_annotation_language="http://www.researchspace.org/pattern/P72_has_language_latehokusai_annotation_language"
                                        P2_has_type_latehokusai_annotation_inscription_type="http://www.researchspace.org/pattern/P2_has_type_latehokusai_annotation_inscription_type"
                                        P73_has_translation_hokusai_annotation="http://www.researchspace.org/pattern/P73_has_translation_hokusai_annotation"
                                        PX_has_transliteration="http://www.researchspace.org/pattern/PX_has_transliteration"
                                      ]]'
      >
        <semantic-form-hidden-input for="classtype" default-value='http://www.cidoc-crm.org/cidoc-crm/E34_Inscription'> </semantic-form-hidden-input>

        <semantic-form-text-input for='P190_has_symbolic_object_late_hokusai_annotation_symbolic'></semantic-form-text-input>
        <semantic-form-text-input for='P73_has_translation_hokusai_annotation'></semantic-form-text-input>
        <semantic-form-tree-picker-input for="P72_has_language_latehokusai_annotation_language"  default-value="http://collection.britishmuseum.org/id/thesauri/THES223120"></semantic-form-tree-picker-input>
        <semantic-form-tree-picker-input for="P2_has_type_latehokusai_annotation_inscription_type" default-value="http://collection.britishmuseum.org/id/thesauri/THES122853"></semantic-form-tree-picker-input>
        <semantic-form-text-input for='PX_has_transliteration'></semantic-form-text-input>
      </semantic-form-composite-input>
        {{/case}}

        {{#case "Mark" break=true}}
      <semantic-form-composite-input render-header=false
                                     for="P65_shows_visual_item_latehokusai_annotation_mark" 
                                     new-subject-template="/E37_Mark/{{{{raw}}}}{{UUID}}{{{{/raw}}}}" 
                                     fields='[[fieldDefinitions
                                          classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                          P2_has_type_latehokusai_annotation_mark_type="http://www.researchspace.org/pattern/P2_has_type_latehokusai_annotation_mark_type"
                                        ]]'
       >
        <semantic-form-tree-picker-input for="P2_has_type_latehokusai_annotation_mark_type"></semantic-form-tree-picker-input>
        <semantic-form-hidden-input for="classtype" default-value='http://www.cidoc-crm.org/cidoc-crm/E37_Mark'> </semantic-form-hidden-input>
      </semantic-form-composite-input>
        {{/case}}

        {{#case "Subject" break=true}}
      <semantic-form-composite-input render-header=false
                                     for="P128_carries_latehokusai_annotation_information" 
                                     new-subject-template="/E73_Information_Object/{{{{raw}}}}{{UUID}}{{{{/raw}}}}" 
                                     fields='[[
                                       fieldDefinitions
                                         classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                         P129_is_about_latehokusai_annotation_subject="http://www.researchspace.org/pattern/P129_is_about_latehokusai_annotation_subject"
                                     ]]'>
        <semantic-form-hidden-input for="classtype" default-value='http://www.cidoc-crm.org/cidoc-crm/E73_Information_Object'> </semantic-form-hidden-input>
        <semantic-form-tree-picker-input for="P129_is_about_latehokusai_annotation_subject"></semantic-form-tree-picker-input>
      </semantic-form-composite-input>    
        {{/case}}

        {{#case "Reference" break=true}}
      <semantic-form-composite-input for="P128_carries_latehokusai_annotation_entity" 
                                     new-subject-template="/E73_Information_Object/{{{{raw}}}}{{UUID}}{{{{/raw}}}}"  
                                     fields='[[
                                      fieldDefinitions
                                        classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                        P67_refers_to_latehokusai_annotation_place="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_place"
                                        P67_refers_to_latehokusai_annotation_period="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_period"
                                        P67_refers_to_latehokusai_annotation_person="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_person"
                                        P67_refers_to_latehokusai_annotation_object="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_object"
                                        P67_refers_to_latehokusai_annotation_thing="http://www.researchspace.org/pattern/P67_refers_to_latehokusai_annotation_thing"
                                      ]]'>
        <semantic-form-hidden-input for="classtype" default-value='http://www.cidoc-crm.org/cidoc-crm/E73_Information_Object'> </semantic-form-hidden-input>

        <semantic-form-autocomplete-input for="P67_refers_to_latehokusai_annotation_person"></semantic-form-autocomplete-input>
        <semantic-form-autocomplete-input for="P67_refers_to_latehokusai_annotation_place"></semantic-form-autocomplete-input>
        <semantic-form-autocomplete-input for="P67_refers_to_latehokusai_annotation_period"></semantic-form-autocomplete-input>
        <semantic-form-autocomplete-input for="P67_refers_to_latehokusai_annotation_thing"></semantic-form-autocomplete-input>
        <semantic-form-autocomplete-input for="P67_refers_to_latehokusai_annotation_object"></semantic-form-autocomplete-input>
      </semantic-form-composite-input>
        {{/case}}    
      {{/switch}}

      <semantic-form-text-input for="P67i_is_referred_to_by_latehokusai_annotation" multiline='true'> </semantic-form-text-input>
      <semantic-form-drag-and-drop-input for="P130_shows_features_of_latehokusai_annotation"></semantic-form-drag-and-drop-input>


    </div>

    <div class="form-btn-group">
      <div style="display: flex; justify-content: flex-end; width: 100%;">
        <mp-event-target-template-render id='save-state' template='{{> template}}'>
          <template id='template'>
            {{#if saved}}
            <div class='save-message fade-out_disappear'>
              The feature has been saved successfully!
            </div>
            {{/if}}
          </template>
        </mp-event-target-template-render>
        <button name="reset" class="btn btn-default">Reset</button>

        {{#if edit}}
          <mp-overlay-dialog id='feature-remove-confirmation-dialog' title="Are you sure you want to remove the feature?" type="modal" bs-size="large">
            <mp-overlay-dialog-trigger>
              <button class="btn btn-grey btn-danger">Delete</button>
            </mp-overlay-dialog-trigger>
            <mp-overlay-dialog-content>
              <div>
                <div>
                  <p>Are you sure you want to remove <strong><mp-label iri='{{feature}}'></mp-label></strong>?</p>
                  <semantic-query 
                                  query='
                                    SELECT ?resource WHERE {
                                      ?resource ?p <{{feature}}> .
                                    }
                                  '
                                  template='{{> referredByTemplate}}'
                  >
                    <template id='referredByTemplate'>
                      Some entities in the system link to the feature:
                      <ul>
                        {{#each bindings}}
                          <li>
                            <semantic-link iri='{{resource.value}}'></semantic-link>
                          </li>
                        {{/each}}
                      </ul>
                    </template>
                  </semantic-query>
                </div>
                <div class="form-btn-group">
                  <div style="display: flex; justify-content: flex-end; width: 100%;">
                    <mp-event-trigger id='cancel-feature-removal' type='OverlayDialog.Close' targets='["feature-remove-confirmation-dialog"]'>
                      <button class="btn btn-default">Cancel</button>
                    </mp-event-trigger>
                    <mp-event-trigger id='confirm-feature-removal' type='Form.RemoveResource' data='{"iri": "{{feature}}"}' targets='["feature-creation-form"]'>
                      <button class="btn btn-grey btn-danger">Delete Feature</button>
                    </mp-event-trigger>  


                    <mp-event-proxy id='close-form-removal-dialog' on-event-source='feature-creation-form' on-event-type='Form.ResourceRemoved'
                                    proxy-event-type='TwoSidePanel.ShowFront' data='{}' proxy-targets='["objects-panel"]'
                    ></mp-event-proxy>
                  </div>
                </div>
              </div>
            </mp-overlay-dialog-content>
          </mp-overlay-dialog>
        {{/if}}


        <button name="submit" class="btn btn-primary">Save</button>
      </div>
    </div>
  </semantic-form>
[[/inline]]

[[#*inline "newFeatureForm"]]
  [[#if createFromRegion]]
    <h2>Creating new Feature represented by the region: &nbsp;<strong><semantic-link iri='{{regionIri}}'></semantic-link></strong></h2>
  [[else]]
    <h2>Creating new Feature for: &nbsp;<strong><semantic-link iri='{{objectIri}}'></semantic-link></strong></h2>
  [[/if]]

  <mp-event-target-template-render id='feature-form-area' template='{{> form}}'>
    <template id='form'>
      [[!-- see the same area copy/pasted bellow --]]
      <div class="feature-form-type-selection-container">
        <p>What kind of feature do you want to create?</p>
        <div class="feature-form-type-selection">
          <mp-event-trigger id='create-mark' type='Component.TemplateUpdate' data='{"featureType": "Mark"}' targets='["feature-form-area"]'>
            <button class='btn-grey {{#ifCond featureType "==" "Mark"}}btn-selected{{/ifCond}}'>Mark</button>
          </mp-event-trigger>
          <mp-event-trigger id='create-inscription' type='Component.TemplateUpdate' data='{"featureType": "Inscription"}' targets='["feature-form-area"]'>
            <button class='btn-grey {{#ifCond featureType "==" "Inscription"}}btn-selected{{/ifCond}}'>Inscription</button>
          </mp-event-trigger> 
          <mp-event-trigger id='create-subject' type='Component.TemplateUpdate' data='{"featureType": "Subject"}' targets='["feature-form-area"]'>
            <button class='btn-grey {{#ifCond featureType "==" "Subject"}}btn-selected{{/ifCond}}'>Subject</button>
          </mp-event-trigger> 
          <mp-event-trigger id='create-reference' type='Component.TemplateUpdate' data='{"featureType": "Reference"}' targets='["feature-form-area"]'>
            <button class='btn-grey {{#ifCond featureType "==" "Reference"}}btn-selected{{/ifCond}}'>Reference</button>
          </mp-event-trigger>  
        </div> 
      </div>
      {{#if featureType}}
        {{> rsp:ImageAnnotationForm create=true [[#if createFromRegion]]createFromRegion=true [[else]] createWithoutRegion=true [[/if]]}}
      {{/if}}
    </template>
  </mp-event-target-template-render>
[[/inline]]

[[#*inline "featureTypesQueryPattern"]]
  ?feature crm:P56i_is_found_on <{{objectIri}}> .
    
  OPTIONAL {
    ?feature crm:P65_shows_visual_item/rdf:type crm:E37_Mark .
    BIND ("Mark" as ?isMark) .
  }
  OPTIONAL {
    ?feature crm:P65_shows_visual_item/rdf:type crm:E34_Inscription .
    BIND ("Inscription" as ?isInscription) .
  }
  OPTIONAL {
    ?feature crm:P128_carries/crm:P129_is_about ?about .
    BIND ("Subject" as ?isSubject) .
  }
  OPTIONAL {
    ?feature crm:P128_carries/crm:P67_refers_to ?reference .
    BIND ("Reference" as ?isReference) .
  }
  BIND(COALESCE(?isMark, ?isInscription, ?isSubject, ?isReference) AS ?featureType)

  OPTIONAL {
    ?feature crm:P138i_has_representation ?region .
    ?region crmdig:L49_is_primary_area_of ?image .
  }
[[/inline]]

[[!-- /INCLUDES --]]


<div class="frame-imageAnnotationWorkspace__container">
      <div class="frame-imageAnnotationWorkspace__viewer">
[[!-- 
 Here we assume that @partial-block is IIIF Viewer component.
 It is defined in the rsp:ThinkingFramesObjectThroughImageObservation template.
--]]
        {{> @partial-block }}
      </div>

      <div class="frame-imageAnnotationWorkspace__observationArea_bg"></div>
      <div class="frame-imageAnnotationWorkspace__observationArea_container">
        
[[!-- 
 `two-side-panel` component functions as kind of a flip panel, with `front` and `back` templates. 
 
 `front` template shows all objects with corresponding features.
 `back` template shows feature creation/editing wizard.  
 
 With `refresh-on-change='false'` we make sure that `front` template with all objects and features is not re-rendered when we switch to it from the `back` panel.
--]]        
              <two-side-panel id='objects-panel' refresh-on-change='false'>
                <template id='front'>            
                  <div class="frame-imageAnnotationWorkspace__observationArea_content">
                    
[[!--
 List of all objects with features. Refreshed by `refresh-image-list` event-proxy at the top of the template.
 Variables available in the template:
 
 objects: Array of { objectIri: object iri string, images: array of image iris strings }
--]]
                    <mp-event-target-template-render id='image-with-regions' template='{{> observations}}'>
                      <template id='observations'>
                        <mp-event-target-template-render id='remove-feature-dialog' template='{{> removeFeatureDialog}}'>
                          <template id='removeFeatureDialog'>
                            {{#if feature}}
                            <mp-event-proxy id='close-form-removal-dialog' on-event-source='feature-creation-form' on-event-type='Form.ResourceRemoved'
                                            proxy-event-type='Component.TemplateUpdate' data='{}' proxy-targets='["remove-feature-dialog"]'
                            ></mp-event-proxy>
                              <div style='display: none;'>
                                {{> rsp:ImageAnnotationForm edit=true delete=true}}
                              </div>
                            {{/if}}
                          </template>
                        </mp-event-target-template-render>

                        
                        <div class="rs-title-row">
                          <h1 class="rs-main-title">Observations</h1>
                          <mp-overlay-dialog title="Object Observations" type="modal" class="modal-xlSize">
                            <mp-overlay-dialog-trigger>
                              <i class="iconmoon iconmoon-info"></i>
                            </mp-overlay-dialog-trigger>
                            <mp-overlay-dialog-content>
                            <div>documentation</div>
                            </mp-overlay-dialog-content>
                          </mp-overlay-dialog>
                        </div>
                        <div class="frame-imageAnnotationWorkspace__observationArea_items">
                          
[[!-- 
 iterate over all objects available in the current IIIF Viewer 
--]]
                          {{#each objects}}
                          
[[!-- 
 To not fully refresh rendered list of objects when image region is created/updated/removed in the IIIF Viewer,
 for every object we listen to all region related events triggered by the IIIF Viewer and refresh only part of the view related to updated object.
--]]
                          <mp-event-proxy id='refresh-object-{{objectIri}}' 
                                          on-event-source='image-editor' 
                                          on-event-types='["IIIFViewer.RegionCreated", "IIIFViewer.RegionUpdated", "IIIFViewer.RegionRemoved"]'
                                          on-event-data='{"objectIri": "{{objectIri}}"}'
                                          proxy-event-type='Component.TemplateUpdate' proxy-targets='["object-template-{{objectIri}}"]'
                          ></mp-event-proxy>
                          
                          <mp-event-proxy id='refresh-object-on-form-action-{{objectIri}}' on-event-source='feature-creation-form'
                                          proxy-event-type='Component.TemplateUpdate' proxy-targets='["object-template-{{objectIri}}"]'
                                          data='{"objectIri": "{{objectIri}}"}'
                          ></mp-event-proxy>
                          
                          <mp-event-target-template-render id='object-template-{{objectIri}}' template='{{> objectTemplate}}'>
                            <template id='objectTemplate'>
                              <div class="frame-imageAnnotationWorkspace__observationArea_resourceTitleRow">
                                <h1 class="text-truncate">Observed on <strong><semantic-link iri='{{objectIri}}'></semantic-link></strong></h1>
                                <div style="display: flex; align-items: flex-start;">
                                  
[[!-- 
 Event trigger that opens new slot in the IIIF Viewer with the images of the current object.
--]]
                                  <mp-event-trigger id='image-view-trigger' 
                                                type='IIIFViewer.AddImagesForObject' 
                                                targets='["image-editor"]'
                                                data='{ "objectIri": "{{objectIri}}" }'>
                                    <button class="btn btn-primary btn-icon">
                                      <i class="rs-icon rs-icon-image" title="View resource images"></i>
                                    </button>
                                  </mp-event-trigger>
                                  
[[!--
 Event trigger that "flips" the panel to "back" view with feature creation wizard.
--]]
                                  <mp-event-trigger id='form-event-trigger' 
                                                    type='TwoSidePanel.ShowBack' 
                                                    targets='["objects-panel"]'
                                                    data='{ "objectIri": "{{objectIri}}" }'>
                                    <button class="btn btn-primary">new feature</button>
                                  </mp-event-trigger>
                                </div>
                              </div>

[[!--
 Query and show list of all image regions that are not associated with any feature, for the current object.
--]]
                              <semantic-query
                                  query='
                                    SELECT DISTINCT ?region ?regionLabel ?image {
                                      <{{objectIri}}> crm:P138i_has_representation|rso:PX_has_main_representation ?image .
                                      ?region crmdig:L49_is_primary_area_of ?image .

                                      FILTER NOT EXISTS {
                                        ?feature crm:P138i_has_representation ?region .
                                      }
                                      ?region rso:displayLabel ?regionLabel .
                                    }
                                  '
                                  template='{{> regionsWithoutFeature}}'
                              >
                                <template id='regionsWithoutFeature'>
                                  <div class="frame-imageAnnotationWorkspace__items page-whiteSection-container">
                                    <h2>Image Regions without Associated Features</h2>
                                    <div class="frame-imageAnnotationWorkspace__item_container">
                                      
[[!--
 Iterate over all query result bindings that represent image regions.
--]]
                                    {{#each bindings}}
                                      <mp-event-trigger id='focus-event-trigger' type='IIIFViewer.HighlightRegion' targets='["image-editor"]'
                                                        data='{"imageIri": "{{image.value}}","regionIri": "{{region.value}}"}' on='["hover"]'
                                      >
                                      <div class="frame-imageAnnotationWorkspace__item">
                                        <semantic-link iri='{{region.value}}' class="text-truncate region-label"></semantic-link>
                                        <div style="display: flex; align-items: center;">
                                          
[[!--
 Event trigger that "flips" the panel to "back" view with feature creation wizard starting from the existng region.
--]]                                         
                                          <mp-event-trigger id='form-event-trigger' 
                                                            type='TwoSidePanel.ShowBack' 
                                                            targets='["objects-panel"]'
                                                            data='{ "regionIri": "{{region.value}}", "regionLabel": "{{regionLabel.value}}", "objectIri": "{{../objectIri}}" }'>
                                            <button class="btn-grey">Create associated feature</button>
                                          </mp-event-trigger>
                                          
                                          <mp-overlay-dialog id='region-remove-confirmation-dialog--{{region.value}}' title="Are you sure you want to remove the region?" type="modal" bs-size="large">
                                            <mp-overlay-dialog-trigger>
                                              <button class="btn-grey btn-icon delete"><i class="iconmoon iconmoon-bin" title="Delete region"></i></button>
                                            </mp-overlay-dialog-trigger>
                                            <mp-overlay-dialog-content>
                                              <div>
                                                <div>
                                                  <p>Are you sure you want to remove <strong><mp-label iri='{{region.value}}'></mp-label></strong>?</p>
                                                </div>
                                                <div class="form-btn-group">
                                                  <div style="display: flex; justify-content: flex-end; width: 100%;">
                                                    <mp-event-trigger id='cancel-feature-removal' type='OverlayDialog.Close' targets='["region-remove-confirmation-dialog--{{region.value}}"]'>
                                                      <button class="btn btn-default">Cancel</button>
                                                    </mp-event-trigger>
                                                    <mp-event-trigger id='remove-region-event-trigger--{{region.value}}' type='IIIFViewer.RemoveRegion' targets='["image-editor"]'
                                                                      data='{"imageIri": "{{image.value}}","regionIri": "{{region.value}}"}'>
                                                      <button class="btn btn-grey btn-danger">Delete Region</button>
                                                    </mp-event-trigger>

                                                    <mp-event-proxy id='close-region-removal-dialog--{{feature.value}}' on-event-source='remove-region-event-trigger--{{region.value}}'
                                                                    proxy-event-type='OverlayDialog.Close' targets='["region-remove-confirmation-dialog--{{region.value}}"]'
                                                    ></mp-event-proxy>
                                                  </div>
                                                </div>
                                              </div>
                                            </mp-overlay-dialog-content>
                                          </mp-overlay-dialog>
                                          
[[!--
 Zoom to the current image region in the IIIF Viewer, creates new slot if the viewer doesn't have active slot with the corresponding image.
--]]                                         
                                          <mp-event-trigger id='focus-event-trigger' type='IIIFViewer.ZoomToRegion' targets='["image-editor"]'
                                                            data='{"imageIri": "{{image.value}}","regionIri": "{{region.value}}"}'>
                                            <button class="btn-grey btn-icon"><i class="rs-icon rs-icon-image" title="Focus on image"></i></button>
                                          </mp-event-trigger>
                                        </div>
                                      </div>
                                      </mp-event-trigger>
                                    {{/each}}
                                    </div>
                                  </div>
                                </template>
                              </semantic-query>

[[!-- 
 Query and show list of all features for the current object.
 
 See the assupmtions related to the data model at the top of the template.
--]]
                              <semantic-query
                                  query='
                                    SELECT DISTINCT ?feature (SAMPLE(?featureType) AS ?featureType) (SAMPLE(?image) AS ?image) (SAMPLE(?region) AS ?region) (IF(COUNT(?r) > 1, true, false) AS ?moreThanOneRegion) (SAMPLE(?user) AS ?user) (SAMPLE(?date) AS ?date) {
                                       [[> featureTypesQueryPattern]]
                                      
                                      
                                      OPTIONAL {
                                        ?feature <http://www.cidoc-crm/cidoc-crm/CRMsci/O8i_was_observed_by> ?observation .
                                        ?observation crm:P2_has_type <http://www.researchspace.org/entity/E55_Type/bdac6431-7d0a-4fa2-b547-6759a071bd1e> .
                                        ?observation crm:P14_carried_out_by ?user .
                                        ?observation crm:P82_at_some_time_within ?date . 
                                      }
                                    } GROUP BY ?feature
                                  '
                                  template='{{> features}}'
                              >
                                <template id='features'>
                                  <div class="frame-imageAnnotationWorkspace__items page-whiteSection-container">
                                    <h2>Features</h2>
                                    <div class="frame-imageAnnotationWorkspace__item_container">
                                    {{#each bindings}}
                                      <mp-event-trigger id='focus-event-trigger' type='IIIFViewer.HighlightRegion' targets='["image-editor"]'
                                                        data='{"imageIri": "{{image.value}}","regionIri": "{{region.value}}"}' on='["hover"]'
                                      >

                                        <div class="frame-imageAnnotationWorkspace__item">
                                          <semantic-link iri='{{feature.value}}' class="text-truncate feature-label"></semantic-link>
                                          {{#if user}}
                                          <i>by <semantic-link iri='{{user.value}}'></semantic-link> on {{dateTimeFormat date.value}}</i>
                                          {{/if}}
                                          <div style="display: flex; align-items: center;">
                                            <mp-event-trigger id='form-event-trigger'
                                                              type='TwoSidePanel.ShowBack' targets='["objects-panel"]'
                                                              data='{ "feature": "{{feature.value}}", "featureType": "{{featureType.value}}", "objectIri": "{{../objectIri}}" }'>
                                              <button class="btn-grey">Edit</button>
                                            </mp-event-trigger>
                                            <mp-event-trigger id='details-view-trigger'
                                                              type='Component.TemplateUpdate'
                                                              data='{"iri": "{{feature.value}}"}' targets='["details-view", "open-details-sidebar"]'
                                            >
                                              <button class="btn-grey btn-icon">
                                                <i class="rs-icon rs-icon-sidebar_right" title="Explore Feature details"></i>
                                              </button>
                                            </mp-event-trigger>
                                              {{#if region}}
                                                <mp-event-trigger id='focus-event-trigger' type='IIIFViewer.ZoomToRegion' targets='["image-editor"]'
                                                                  data='{"imageIri": "{{image.value}}","regionIri": "{{region.value}}"}'>
                                                    <button class="btn-grey btn-icon"><i class="rs-icon rs-icon-image" title="Focus on Feature"></i></button>
                                                </mp-event-trigger>
                                              {{else}}
                                              <div style="position: relative;">
                                                <button disabled class="btn-grey btn-icon">
                                                  <i class="rs-icon rs-icon-image" title="The feature has no image associated"></i>
                                                </button>
                                                <i class="fa fa-exclamation-circle" title="The feature has no image associated"></i>
                                              </div>
                                              {{/if}}

                                            <mp-event-trigger id='remove-feature-trigger--{{feature.value}}'
                                                              type='Component.TemplateUpdate'
                                                              data='{ "feature": "{{feature.value}}", "featureType": "{{featureType.value}}", "objectIri": "{{../objectIri}}" }'
                                                              targets='["remove-feature-dialog"]'
                                                              >
                                              <button class="btn-grey btn-icon delete"><i class="iconmoon iconmoon-bin" title="Delete feature"></i></button>

                                            </mp-event-trigger>
                                          </div>
                                        </div>
                                      </mp-event-trigger>
                                    {{/each}}
                                    </div>
                                  </div>
                                </template>
                              </semantic-query>
                              </template>
                            </mp-event-target-template-render>
                          {{/each}}
                        </div>
                      </template>
                    </mp-event-target-template-render>
                  </div>
                </template>
                
                <template id='back'>
                  <div class="frame-imageAnnotationWorkspace__formArea_container">
                    <mp-event-trigger id='form-panel-back' 
                                      type='TwoSidePanel.ShowFront' 
                                      targets='["objects-panel"]'
                    >
                      <div class="back-container">
                        <i class="iconmoon iconmoon-arrow-left2"></i>
                      </div>
                    </mp-event-trigger>

                    <div class="frame-imageAnnotationWorkspace__form-titleRow">
                      <h1 class="text-truncate">Observation on <strong><semantic-link iri='{{objectIri}}'></semantic-link></strong></h1>
                      <button class="btn btn-primary btn-icon"><i class="rs-icon rs-icon-image" title="Focus on resource images"></i></button>
                    </div>
                                  
                    {{#if feature}}                    
                      <div class="frame-imageAnnotationWorkspace__form-container page-whiteSection-container frame-imageAnnotationWorkspace__form-edit">
                        <h2>Editing feature: &nbsp;<strong><semantic-link iri='{{feature}}'></semantic-link></strong></h2>
                        <div class="frame-imageAnnotationWorkspace__form-edit-featureType">
                          <span class="semantic-form-input-decorator__label" style="margin-right: 10px;">Kind:</span>
                          <span class='btn-grey btn-selected'>{{featureType}}</span>
                        </div>
                        {{> rsp:ImageAnnotationForm edit=true}}
                      </div>
                    {{else}}
                      {{#if regionIri}}
                        <div class="frame-imageAnnotationWorkspace__form-container page-whiteSection-container">
                          <semantic-if query='
                                        ASK { 
                                          ?feature crm:P56i_is_found_on <{{objectIri}}>. 
                                          OPTIONAL {
                                            ?feature crm:P138i_has_representation ?region .
                                            ?region crmdig:L49_is_primary_area_of ?image .
                                          }
                                          FILTER(!BOUND(?image))  
                                        }
                                       '
                          >
                            <template id='then'>
                                <mp-event-target-template-render id='new-region-wizard-area' template='{{> newRegionWizard}}'>
                                  <template id='newRegionWizard'>
                                    {{#if useExisting}}
                                        <semantic-query 
                                                        query='
                                                         SELECT DISTINCT ?feature ?featureType {
                                                             [[> featureTypesQueryPattern]]
                                                             FILTER(!BOUND(?image))  
                                                          }
                                                        '
                                                        template='{{> existingFeatureSelection}}'
                                        >
                                          <template id='existingFeatureSelection'>
                                            <div class="frame-imageAnnotationWorkspace__items page-whiteSection-container">
                                              <h2>Select existing feature:</h2>
                                              <div class="frame-imageAnnotationWorkspace__item_container">
                                                {{#each bindings}}
                                                <div class="frame-imageAnnotationWorkspace__item">
                                                  <semantic-link iri='{{feature.value}}' class="text-truncate feature-label"></semantic-link> 
                                                  <div style="display: flex; align-items: center;">
                                                    <mp-event-trigger id='use-existing-feature'
                                                                      type='Component.TemplateUpdate' 
                                                                      data='{"confirmExisting": true, "feature": "{{feature.value}}", "featureType": "{{featureType.value}}", "objectIri": "{{../objectIri}}", "regionIri": "{{../regionIri}}"}' 
                                                                      targets='["new-region-wizard-area"]'
                                                    >
                                                      <button class='btn-grey'>Select</button>
                                                    </mp-event-trigger>
                                                  </div>
                                                </div>
                                                {{/each}}
                                              </div>
                                            </div>

                                          </template>
                                    
                                        </semantic-query>
                                    {{else if confirmExisting}}
                                      <div class="frame-imageAnnotationWorkspace__items page-whiteSection-container">
                                        <h2>
                                          Associating image region with the feature: &nbsp;<strong><semantic-link iri='{{feature}}'></semantic-link></strong> of the &nbsp; object: <strong><semantic-link iri='{{objectIri}}'></semantic-link></strong>
                                        </h2>
                                        <div class="frame-imageAnnotationWorkspace__form-edit-featureType">
                                          <span class="semantic-form-input-decorator__label" style="margin-right: 10px;">Kind:</span>
                                          <span class='btn-grey btn-selected'>{{featureType}}</span>
                                        </div>
                                        <semantic-form 
                                           id='feature-creation-form'
                                           post-action='event'
                                           subject='{{feature}}'
                                           persistence='{"type": "sparql", "targetInsertGraphIri": "http://www.researchspace.org/ns/data-updates-graph-test"}'

                                          fields='[[
                                           fieldDefinitions
                                             P138i_has_representation_latehokusai_representation="http://www.researchspace.org/pattern/P138i_has_representation_latehokusai_representation"
                                          ]]'
                                        >
                                          <div class="form-scrollable-area">
                                            <semantic-form-drag-and-drop-input  for="P138i_has_representation_latehokusai_representation" default-value='{{regionIri}}' force-defaults=true readonly=true></semantic-form-drag-and-drop-input>
                                          </div>
                                          <div class="form-btn-group">
                                            <div style="display: flex; justify-content: flex-end; width: 100%;">
                                              <mp-event-target-template-render id='save-state' template='{{> template}}'>
                                                <template id='template'>
                                                  {{#if saved}}
                                                  <div class='save-message fade-out_disappear'>
                                                    The region has been updated successfully!
                                                  </div>
                                                  {{/if}}
                                                </template>
                                              </mp-event-target-template-render>
                                              <mp-event-trigger id='cancel-region-association' type='Component.TemplateUpdate' data='{"useExisting": true}' targets='["new-region-wizard-area"]'>
                                                <button class='btn btn-grey btn-danger'>Cancel</button>
                                              </mp-event-trigger> 

                                              <button name="submit" class="btn btn-primary">Confirm</button>
                                            </div>
                                          </div>
                                        </semantic-form>
                                      </div>
                                    {{else if createNew}}
                                      [[> newFeatureForm createFromRegion=true]]
                                    {{else}}
                                      <p>Do you want to create a new feature or use the region as a representation of an existing one for the following region?</p>
                                      <div style='display: flex'>
                                        <mp-event-trigger id='use-existing-feature' type='Component.TemplateUpdate' data='{"createNew": true}' targets='["new-region-wizard-area"]'>
                                          <button class='btn-grey'>Create New</button>
                                        </mp-event-trigger> 
                                        <mp-event-trigger id='use-existing-feature' type='Component.TemplateUpdate' data='{"useExisting": true}' targets='["new-region-wizard-area"]'>
                                          <button class='btn-grey'>Use Existing</button>
                                        </mp-event-trigger> 
                                      </div>
                                    {{/if}}
                                  </template>
                                </mp-event-target-template-render>
                            </template>
                            <template id='else'>
                              [[> newFeatureForm createFromRegion=true]]
                            </template>
                          </semantic-if>
                        </div>
                      {{else}}
                        {{#if objectIri}}
                          <div class="frame-imageAnnotationWorkspace__form-container page-whiteSection-container">
 												    [[> newFeatureForm createFromRegion=false]]
                          </div>
                        {{/if}}
                      {{/if}}
                    {{/if}}

                  </div>
                </template>
              </two-side-panel>

         
      </div>

  </div>
