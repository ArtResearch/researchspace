<semantic-table id='semantic-search-result-table'
                query='SELECT DISTINCT ?reference ?description ?existingRecord ?exists ?hasId ?catalogueLevel ?citableReference ?descriptionWithoutHighlight
                        WHERE {
                          {{#if initial}}
                            FILTER(BOUND(?reference)) .
                            FILTER(?catalogueLevel in (3, 6, 7)) .
                            BIND(REPLACE(REPLACE(?reference, "</span>", ""), "<span class=\"highlight\">", "") AS ?citableReference) .

                            OPTIONAL {
                              ?existingRecord crm:P1_is_identified_by ?identifier .
                              ?identifier crm:P2_has_type <http://www.researchspace.org/resource/vocab/identifier/crn> ;
                                          rdfs:label ?citableReference .                                          
                            }
                            BIND(BOUND(?identifier) as ?exists) .
                            BIND(REPLACE(REPLACE(REPLACE(?description, "</span>", ""), "<span class=\"highlight\">", ""), "\"", "`") AS ?descriptionWithoutHighlight) .
                          {{else}}
                            OPTIONAL {
                              ?existingRecord crm:P1_is_identified_by ?identifier .
                              ?identifier crm:P2_has_type <http://www.researchspace.org/resource/vocab/identifier/crn> ;
                                          rdfs:label ?citableReference .
                            }
                            BIND(BOUND(?identifier) as ?exists) .
                            BIND(?numberRef as ?score) .
                            BIND(?citableReference as ?reference) .
                            BIND(REPLACE(?description, "\"", "`") AS ?descriptionWithoutHighlight) .
                          {{/if}}
                        } 
                        {{orderBy}}'

                number-of-displayed-rows=20
                options='{"showFilter":false}' 
                column-configuration='[{"displayName": "Object", "variableName": "reference", "cellTemplate": "{{> reference}}" },
                                        {"displayName": "Catalogue level", "variableName": "catalogueLevel", "cellTemplate": "{{> catalogueLevel}}" },
                                        {"displayName": "Description", "variableName": "description", "cellTemplate": "{{{{raw}}}}{{{description.value}}}{{{{/raw}}}}" },
                                        {"displayName": "Actions", "cellTemplate": "{{> actions}}" }
                                      ]'
                >
  <template id='reference'>
    <mp-event-target-template-render id='{{viewId}}-tna-collection-item-reference-{{__semanticTableIndex.value}}' template='{{> template}}'>
      <template id='template'>
        {{#ifCond exists.value "==" "true"}}
          <div style="display: flex; align-items: center;"> 

            <mp-draggable iri='{{existingRecord.value}}'>
              <div style="display: flex; align-items: center; cursor: grab;">
                <i class="rs-icon rs-icon-drag_points" style="margin-right: 8px;"></i> 
                <semantic-link iri="http://www.researchspace.org/resource/ThinkingFrames" draggable='false'
                               urlqueryparam-view='entity-editor' urlqueryparam-resource-iri='{{existingRecord.value}}'
                               class='a-draggable' title='{{citableReference.value}}'
                               >
                  {{{reference.value}}}
                </semantic-link>

              </div>
            </mp-draggable>
          </div>
        
        {{else}}
          {{#if saved}}
            <mp-draggable iri='{{existingRecord.value}}'>
              <div style="display: flex; align-items: center; cursor: grab;">
                <i class="rs-icon rs-icon-drag_points" style="margin-right: 12px;"></i>                
                <semantic-link iri="http://www.researchspace.org/resource/ThinkingFrames" draggable='false'
                                urlqueryparam-view='entity-editor' urlqueryparam-resource-iri='{{iri}}'
                                class='a-draggable' title='{{citableReference.value}}'
                                >
                  {{{reference.value}}}
                </semantic-link>
              </div>
            </mp-draggable>
          {{else}}
            {{{reference.value}}}
          {{/if}}
        {{/ifCond}}
      </template>
    </mp-event-target-template-render>
  </template>
  
  <template id='catalogueLevel'>
    {{#switch catalogueLevel.value}}
      {{#case "3" break=true}}
        Series
      {{/case}}
      {{#case "6" break=true}}
        Piece
      {{/case}}
      {{#case "7" break=true}}
        Item
      {{/case}}
      {{#default}}
        {{catalogueLevel.value}}
      {{/default}}
    {{/switch}}
  </template>
  
  <template id='actions'>
    <mp-event-target-template-render id='{{viewId}}-tna-collection-item-actions-{{__semanticTableIndex.value}}' template='{{> template}}'>
      <template id='template'>
        <div>
          {{#if saved}}
            <semantic-link iri="http://www.researchspace.org/resource/ThinkingFrames" draggable='false'
                            urlqueryparam-view='entity-editor' urlqueryparam-resource-iri='{{iri}}'
                            class='a-btn-container'
                            >
              <button class="btn btn-table btn-default">Edit</button>
            </semantic-link>
          {{else}}
            {{#if (or (eq catalogueLevel.value "3") (eq catalogueLevel.value "6") (eq catalogueLevel.value "7") )}}
              {{#if (eq exists.value "false")}}
                <div style='display: none'>
                  <inline-template template-iri='http://www.researchspace.org/resource/system/forms/ManMadeObject' 
                                    options='{
                                            "formId": "{{viewId}}-tna-collection-item-form-{{__semanticTableIndex.value}}",
                                            "reference": "{{citableReference.value}}",
                                            "catalogue_level": "{{catalogueLevel.value}}",
                                            "description": "{{descriptionWithoutHighlight.value}}"
                                            }'>
                  </inline-template>
                </div>

                <mp-event-proxy id='{{viewId}}-tna-collection-item-on-form-save-{{__semanticTableIndex.value}}' 
                                on-event-source='{{viewId}}-tna-collection-item-form-{{__semanticTableIndex.value}}'
                                on-event-types='["Form.ResourceCreated", "Form.ResourceUpdated"]'
                                additional-data='{"saved": "true"}'
                                proxy-event-type='Component.TemplateUpdate' 
                                proxy-targets='["{{viewId}}-tna-collection-item-reference-{{__semanticTableIndex.value}}",  
                                              "{{viewId}}-tna-collection-item-actions-{{__semanticTableIndex.value}}" 
                                              ]'>
                </mp-event-proxy>

                <mp-event-trigger id='{{viewId}}-tna-collection-item-save-{{__semanticTableIndex.value}}' 
                                  type='Form.Save' 
                                  targets='["{{viewId}}-tna-collection-item-form-{{__semanticTableIndex.value}}"]'>
                  <button class="btn btn-table btn-action">
                      Import
                  </button>
                </mp-event-trigger>
              {{else}}
                <semantic-link iri="http://www.researchspace.org/resource/ThinkingFrames" draggable='false'
                                urlqueryparam-view='entity-editor' urlqueryparam-resource-iri='{{existingRecord.value}}'
                                class='a-btn-container'
                >
                  <button class="btn btn-table btn-default">Edit</button>
                </semantic-link>
              {{/if}}
            {{/if}}
          {{/if}}       
        </div>
      </template>
    </mp-event-target-template-render>
  </template>

</semantic-table>