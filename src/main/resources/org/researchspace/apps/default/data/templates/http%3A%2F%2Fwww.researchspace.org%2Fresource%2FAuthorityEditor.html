[[!--
uses client-side template:
[[> rsp:HierarchyManagerTemplate]]
--]]

<div>

[[!--
  About VOCABULARY and AUTHORITY representation:

  This application page is used to create and edit skos:ConceptScheme or crm:E32_Authority_Document, corresponding to thesauri or authority lists.
  Creating a skos:ConceptScheme is suitable for hierarchical conceptual structure where the hierarchy is best described by broader or narrower type of relations.
  Creating a crm:E32_Authority_Document can represent lists of persons, periods, events, etc. The assumption is that all entities in an Authority Document have the same
  type and relations between entities are based on cidoc-crm entities and their corresponding properties; 

--]]
[[#> rsp:HierarchyManagerTemplate title="Authorities" addTitle='Authority']]
    [[#*inline "addNewStructureForm"]]
    
      <semantic-search id="scheme-iri-selector">
        <semantic-search-form-query 
                                    query-template='{
                                      "queryString": "SELECT $schemeLabel ?schemeDescription ?entityTypeURI  { 
                                        BIND($label as ?schemeLabel).
                                        BIND($description as ?schemeDescription).
                                        BIND(?entitytype as ?entityTypeURI )}",
                                     
                                        "arguments": {
                                        "label": {"type": "xsd:string"},
                                        "description": {"type": "xsd:string", "optional": true},
                                        "entitytype":{"type":"xsd:anyURI"}
                                      }
                                    }'

                                    fields='[{"id": "label", "label": "Authority label", "xsdDatatype": "http://www.w3.org/2001/XMLSchema#string"},
                                             {"id": "description", "label": "Authority description", "xsdDatatype": "http://www.w3.org/2001/XMLSchema#string"},
                                            {
                                            "id": "entitytype",
                                            "label": "Authority Type",
                                            "xsdDatatype": "xsd:anyURI",
                                            "valueSetPattern": "SELECT $value $label WHERE { 
                                                                  ?value <http://www.cidoc-crm.org/cidoc-crm/P71i_is_listed_in> <http://www.researchspace.org/resource/system/resource_configurations_container> .
                                                                  ?value <http://www.researchspace.org/pattern/system/resource_configuration/resource_label> ?label .
                                                                } ORDER BY ASC(?label)"
                                            }
                                    ]'>
                            
            <div class="newAuthority-modal-form-content">
              <semantic-form-text-input for="label" placeholder="Enter authority label" label="Authority label" ></semantic-form-text-input> 
              <semantic-form-text-input for="description" placeholder="Enter authority description" label="Authority description" multiline='true'></semantic-form-text-input>        

              <div class="authorityType-checklist-input-container">
                <semantic-form-checklist-input for='entitytype' type="checkbox" label="Authority type" ></semantic-form-checklist-input>
              </div>
              <semantic-form-errors></semantic-form-errors>

            
              <div style="display: flex; justify-content: end;">
                <mp-event-trigger id='{{viewId}}-cancel-new-authority-trigger' 
                                  type='OverlayDialog.Close' 
                                  targets='["{{viewId}}-new-hierarchy-dialog"]'>
                    <button name="cancel" class="btn btn-default" style="margin-right: 5px;">Cancel</button>
                </mp-event-trigger>
                <button name='submit' type="submit" class='btn btn-action'>Create authority</button>
              </div>
            </div>
        </semantic-search-form-query>

        <semantic-search-result-holder>
          <semantic-search-result>
            <semantic-query id='new-scheme-query-form' query='
                                    SELECT ?schemeLabel ?scheme ?entityType ?entityTypeLabel ?schemeDescriptionText ?exists ?viewId WHERE {
                                      BIND("{{viewId}}" as ?viewId)
                                      BIND(IRI(CONCAT(STR(Default:), "vocab/", ENCODE_FOR_URI(REPLACE(LCASE(?schemeLabel), "\\s", "_")))) AS ?scheme) .
                                      BIND(?entityTypeURI as ?entityType)
                                      ?entityType <http://www.researchspace.org/pattern/system/resource_configuration/resource_label> ?entityTypeLabel .
                                      BIND (bound(?schemeDescription) AS ?schemeDescriptionText) . 
                                   #   BIND (IF(?schemeDescription , ?schemeDescription, false) AS ?schemeDescriptionText)
                                      OPTIONAL {
                                        ?scheme a skos:ConceptScheme .
                                        BIND(true as ?exists) .
                                      }
                                      OPTIONAL {
                                        ?scheme a crm:E32_Authority_Document .
                                        BIND(true as ?exists) .
                                      }
                                    }
                                  '
                                  template='{{> template}}'
                                  >
              <template id='template'>
                  {{#if bindings.0.exists}}
                    <div class="confirm-message alert alert-warning">
                      <div>Authority with label <b>{{bindings.0.schemeLabel.value}}</b> and type <b>{{bindings.0.entityTypeLabel.value}}</b> already exists!</div> 
                    </div>
                  {{else}}
                    <div class="confirm-message alert alert-info">
                      <div>Are you sure you want to create a new authority with IRI: <b>{{bindings.0.scheme.value}}</b> ?</div>   
                      
                      <semantic-form id='{{bindings.0.viewId.value}}-new-scheme-form' 
                                    persistence='{"type": "sparql", "targetGraphIri": "{{bindings.0.scheme.value}}"}'
                                    new-subject-template='{{bindings.0.scheme.value}}'
                                    post-action="event"
                                    fields='[[fieldDefinitions
                                              classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                              rdfsLabel="http://www.w3.org/2000/01/rdf-schema#label"
                                              scheme_refersto_type="http://www.researchspace.org/pattern/system/scheme/refers_to"
                                              scheme_description="http://www.researchspace.org/pattern/system/entity/description"
                                            ]]'
                      >
                        
                        <semantic-form-hidden-input for="classtype" default-values='["http://www.cidoc-crm.org/cidoc-crm/E32_Authority_Document","http://www.cidoc-crm.org/cidoc-crm/E73_Information_Object"]'></semantic-form-hidden-input>
                        <semantic-form-hidden-input for="rdfsLabel" default-value='{{bindings.0.schemeLabel.value}}'></semantic-form-hidden-input>   
                        
                        <semantic-form-hidden-input for="scheme_refersto_type" default-value='{{bindings.0.entityType.value}}'></semantic-form-hidden-input>
                        <semantic-form-hidden-input for="scheme_description" default-value='{{bindings.0.schemeDescriptionText.value}}'></semantic-form-hidden-input>

                        <semantic-form-errors></semantic-form-errors>
                        <!-- save and reset button for form -->
                        <mp-event-trigger id='{{bindings.0.viewId.value}}-cancel-new-authority-trigger' 
                                          type='OverlayDialog.Close' 
                                          targets='["{{bindings.0.viewId.value}}-new-hierarchy-dialog"]'>
                          <button name="cancel" class="btn btn-default" style="margin-right: 5px;">Cancel</button>
                        </mp-event-trigger>

                        <button name="submit" class="btn btn-action">Confirm</button>

                      </semantic-form>
                    </div>
                  {{/if}}
              </template>
            </semantic-query>
          </semantic-search-result>
        </semantic-search-result-holder>
      </semantic-search>
   
    [[/inline]]
    [[#*inline "customUploadNewStructureMessage"]]
       <p>Please drag&amp;drop your *.trig or *.nq RDF file(s) with SKOS vocabularies here or Authority Document with heterogeneous data.</p>
       <p>For a <i>skos:ConceptScheme</i> or <i>crm:E32_Authority_Document</i> all corresponding entities should be defined in one named graph that equals to the scheme IRI!</p>             
    [[/inline]]
    [[#*inline "exceptionsStructureList"]]
      <semantic-query query='
                        SELECT ?scheme ?schemeGraph WHERE { 
                          {
                            GRAPH ?schemeGraph {
                              ?scheme a skos:ConceptScheme .
                            }
                          }
                          UNION {
                            GRAPH ?schemeGraph {
                              ?scheme a crm:E32_Authority_Document .
                            }
                          }
                          MINUS {
                            ?scheme crm:P2_has_type <http://www.researchspace.org/resource/system/System_Resource>
                          }
                          FILTER(?schemeGraph != ?scheme) .
                        }
                        ' 
                      template='{{> template}}'
                      >
        <template id='template'>
          <div class='alert alert-warning'>
            <div style="margin-bottom: 5px; font-size: 15px;">
              <strong>Warning! &nbsp; There are vocabularies in the system 
              that can't be edited with Vocabulary Manager.</strong>
            </div> 
            <div>
              <i>skos:ConceptScheme</i>, as well as <i>crm:E32_Authority_Document</i> and all their 
              corresponding entities should be defined in one named graph that equals to the scheme IRI.
            </div>
            <ul>
              {{#each bindings}}<li><semantic-link iri='{{scheme.value}}'></semantic-link> - IRI: {{scheme.value}} , in the graph: {{schemeGraph.value}}</li>{{/each}}
            </ul>
          </div>
        </template>
      </semantic-query>
    [[/inline]]
    [[#*inline "searchResults"]]
      <semantic-search>
        <semantic-search-query-keyword query='
                    PREFIX bds: <http://www.bigdata.com/rdf/search#>
                    SELECT ?scheme ?schemeLabel ?isManaged WHERE {
                      {
                        GRAPH ?scheme {
                          ?scheme a skos:ConceptScheme ;
                                  skos:prefLabel ?schemeLabel .
                          ?schemeLabel bds:search ?__token__ .
                        }
                      }
                      UNION {
                        GRAPH ?scheme {
                          ?scheme rdf:type crm:E32_Authority_Document ;
                                  rdfs:label ?schemeLabel .
                          ?schemeLabel bds:search ?__token__ .
                        }
                      }
                      
                      OPTIONAL {
                        ?scheme crm:P67_refers_to ?managedConfig .
                      }
                      MINUS {
                        ?scheme crm:P2_has_type <http://www.researchspace.org/resource/system/System_Resource>
                      }
                      BIND(BOUND(?managedConfig) as ?isManaged) .
                    }
                '
                default-query='
                    SELECT DISTINCT ?scheme ?schemeLabel ?isManaged ?authorityTypeLabel WHERE {
                            {
                                GRAPH ?scheme {
                                    ?scheme rdf:type skos:ConceptScheme;
                                            skos:prefLabel ?schemeLabel.
                                    BIND(skos:ConceptScheme AS ?schemeType)
                                }
                            }
                            UNION
                            {
                                GRAPH ?scheme {
                                    ?scheme rdf:type crm:E32_Authority_Document;
                                            rdfs:label ?schemeLabel.

                                    BIND(crm:E32_Authority_Document AS ?schemeType)
                                }
                            }
                      MINUS {
                        ?scheme crm:P2_has_type <http://www.researchspace.org/resource/system/System_Resource>
                      }

                      OPTIONAL {
                        ?scheme crm:P67_refers_to ?managedConfig .
                      }

                      BIND(BOUND(?managedConfig) as ?isManaged) 
                      OPTIONAL {
                        ?scheme crm:P67_refers_to ?authorityType .
                        ?authorityType <http://www.researchspace.org/pattern/system/resource_configuration/resource_label> ?authorityTypeLabel .
                      }
                      OPTIONAL {
                     
                      }
                    }
                '
        ></semantic-search-query-keyword>

        <div style="margin-top: 20px;">
          <semantic-search-result-holder>
              <semantic-search-result>
                <semantic-table id='scheme-table'
                                query='SELECT DISTINCT ?scheme ?schemeLabel ?isManaged ?authorityTypeLabel WHERE {} ORDER BY ASC(STR(LCASE(?schemeLabel)))'
                                number-of-displayed-rows=15
                                options='{"showFilter": false}'
                                no-result-template='{{> noScheme}}'
                                column-configuration='[ {"variableName": "schemeLabel", "displayName": "Authority", "cellTemplate": "{{> authority}}" },
                                                        {"variableName": "authorityTypeLabel", "displayName": "Type"},
                                                        {"variableName": "authorityTypeLabel", "displayName": "Description"},
                                                        {"variableName": "scheme", "displayName": "Actions", "cellTemplate": "{{> actions}}" }
                                                      ]'>
                      <template id="noScheme">
                          <div style="padding: 12px 8px">
                              No vocabulary available
                          </div>
                      </template>

                      <template id='authority'>
                        <semantic-link iri="http://www.researchspace.org/resource/ThinkingFrames"
                              urlqueryparam-view='authority-content' 
                              urlqueryparam-resource='{{scheme.value}}'
                              urlqueryparam-mode='new'
                            >
                              <div class="table-title">{{schemeLabel.value}}</div>
                        </semantic-link>
                      </template>

                      <template id='actions'>
                          <div class="scheme-table-row"> 
                            <div class="btn-inline-container">
            <!--                <mp-event-trigger id='{{viewId}}-set-action__reading-add-add-frame' type='Dashboard.AddFrame' 
                                    data='{"resourceIri": "{{scheme.value}}", "viewId": "authority-content","frameId":"{{viewId}}"}' 
                                    targets='["thinking-frames"]'>
                                    <button class="btn btn-default">Show Terms</button>
                                </mp-event-trigger> -->
                                <mp-overlay-dialog title="Edit {{schemeLabel.value}}" type="modal" bs-size="large" class="editAuthority-modal">
                                  <mp-overlay-dialog-trigger>
                                    <button class="btn btn-icon" title="Edit">
                                      <rs-icon icon-type="round" icon-name="edit"></rs-icon>
                                    </button>
                                  </mp-overlay-dialog-trigger>
                                  <mp-overlay-dialog-content>
                                    
                                      {{#ifCond isManaged.value "===" "true"}}
                                        <semantic-form id='vocab-form' 
                                                        persistence='{"type": "sparql", "targetGraphIri": "{{scheme.value}}"}'
                                                        subject='{{scheme.value}}'
                                                        post-action="reload"
                                                        fields='[[fieldDefinitions
                                                                  rdfsLabel="http://www.w3.org/2000/01/rdf-schema#label"
                                                                  prefLabel="http://www.researchspace.org/pattern/system/entity/skos_prefLabel"
                                                                  classtype="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                                                        ]]'
                                        >
                                          <semantic-form-text-input for="rdfsLabel"> </semantic-form-text-input>
                                          <semantic-form-text-input for="prefLabel"> </semantic-form-text-input>

                                          <semantic-form-errors></semantic-form-errors>

                                          <button name="reset" class="btn btn-default">Reset</button>
                                          <button name="submit" class="btn btn-action">Save</button>
                                        </semantic-form>
                                      {{else}}            
                                          <semantic-form id='manage-scheme-form' 
                                                        persistence='{"type": "sparql", "targetGraphIri": "{{scheme.value}}"}'
                                                        subject='{{scheme.value}}'
                                                        post-action="redirect"
                                                        fields='[{
                                                          "id": "refersto",
                                                          "label": "Entity Type",
                                                          "xsdDatatype": "xsd:anyURI",
                                                          "minOccurs": "1",
                                                          "maxOccurs": "1",
                                                          "insertPattern": "INSERT { $subject <http://www.cidoc-crm.org/cidoc-crm/P67_refers_to> $value } WHERE {}",
                                                          "deletePattern": "DELETE { $subject <http://www.cidoc-crm.org/cidoc-crm/P67_refers_to> $value . } WHERE { $subject <http://www.cidoc-crm.org/cidoc-crm/P67_refers_to> $value. }",
                                                          "valueSetPattern": "SELECT $value $label WHERE { 
                                                              ?value crm:P71i_is_listed_in <http://www.researchspace.org/resource/system/resource_configurations_container> .
                                                              ?value <http://www.researchspace.org/pattern/system/resource_configuration/resource_label> ?label .
                                                            }"
                                                          }
                                                        ]'
                                          >

                                          <div>
                                            <p>Authority List <b>{{schemeLabel.value}}</b> is not managed by the system.</p>
                                            <div>Enable Authority authoring:</div>   

                                            <div style="overflow: auto; margin-top: 15px;">
                                              <semantic-form-checklist-input for='refersto' type="checkbox" label="Authority type"></semantic-form-checklist-input>
                                            </div>
                                            
                                            <semantic-form-errors></semantic-form-errors>
                                            
                                            <div class="btn-group">
                                              <div class="btn-form-actions">
                                                <button name="cancel" class="btn btn-default">Cancel</button>
                                                <button name="submit" class="btn btn-action" >Confirm</button>
                                              </div>
                                            </div>
                                          </div>
                                            
                                        </semantic-form>
                                      {{/ifCond}}
                                  
                                  </mp-overlay-dialog-content>
                                </mp-overlay-dialog>
                            
                                <mp-graph-store-action title="Download" action="GET" graphuri="{{scheme.value}}" file-ending="trig">
                                  <button class="btn btn-icon" title="Download">
                                    <rs-icon icon-type="round" icon-name="download" style="font-size: 21px; padding-bottom:0;"></rs-icon>
                                  </button>
                                </mp-graph-store-action>
                            
                                <mp-graph-store-action title="Delete" action="DELETE CUSTOM" graphuri="{{scheme.value}}" graph-description="{{schemeLabel.value}}">
                                  <button class="btn btn-icon" title="Delete">
                                    <rs-icon icon-type="round" icon-name="delete"></rs-icon>
                                  </button>
                                </mp-graph-store-action>
                            </div>
                          </div>
                      </template>
                </semantic-table>
              </semantic-search-result>
          </semantic-search-result-holder>
        </div>
      </semantic-search>
    [[/inline]]

[[/rsp:HierarchyManagerTemplate]]

</div>