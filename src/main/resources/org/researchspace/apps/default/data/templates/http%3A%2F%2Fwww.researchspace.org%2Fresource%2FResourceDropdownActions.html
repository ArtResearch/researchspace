<bs-dropdown id="{{viewId}}-{{iri}}-item-actions-dropdown" pull-right=true class="dropdown-no-caret">
  <bs-dropdown-toggle class="{{#if resourceEditorButton}}{{else}}border-none {{#if cardButton}}resource-card__button{{/if}}{{/if}}">
    <rs-icon icon-type="round" icon-name="more_vert"></rs-icon>
  </bs-dropdown-toggle>

  <bs-dropdown-menu class="resource-card__dropdown-menu {{#if (or clipboardCard cardInDragAndDropInput)}}resource-card__dropdown-multitle-actions{{/if}}
                          {{#if (or clipboardCard cardInDragAndDropInput narrativeCard)}}resource-card__dropdown-small{{/if}}
                          {{#if knowledgeMapCard}}resource-card__dropdown-km{{/if}}">

    {{#switch resourceConfig}}
      {{#case "http://www.researchspace.org/resource/system/resource_configurations_container/data/Semantic_narrative" break=true}}
        <mp-event-trigger id='{{viewId}}-open-narrative-trigger' 
                          type='Dashboard.AddFrame'
                          data='{"viewId":"semantic-narrative", 
                                  "resourceIri": "{{iri}}"}' 
                          targets='["thinking-frames"]'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="description" class="icon-left" symbol="true"></rs-icon>
            <span>Open narrative</span>
          </bs-menu-item>
        </mp-event-trigger>

        <mp-event-trigger id='{{viewId}}-open-narrative-newTab-trigger' 
                          type='Dashboard.AddFrame'
                          data='{ "viewId":"semantic-narrative", 
                                  "resourceIri": "{{iri}}",
                                  "openAsDragAndDrop":true
                                }' 
                          targets='["thinking-frames"]'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="tab_move" class="icon-left" symbol="true"></rs-icon>
            <span>Open narrative in draggable tab</span>
          </bs-menu-item>
        </mp-event-trigger>
        <hr>
      {{/case}}

      {{#case "http://www.researchspace.org/resource/system/resource_configurations_container/data/Knowledge_map" break=true}}
        <mp-event-trigger id='{{viewId}}-open-km-trigger' 
                          type='Dashboard.AddFrame'
                          data='{"viewId":"knowledge-map", 
                                  "resourceIri": "{{iri}}"}' 
                          targets='["thinking-frames"]'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="account_tree" class="icon-left" symbol="true"></rs-icon>
            <span>Open knowledge map</span>
          </bs-menu-item>
        </mp-event-trigger>

        <mp-event-trigger id='{{viewId}}-open-km-newTab-trigger' 
                          type='Dashboard.AddFrame'
                          data='{ "viewId":"knowledge-map", 
                                  "resourceIri": "{{iri}}",
                                  "openAsDragAndDrop":true
                                }' 
                          targets='["thinking-frames"]'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="tab_move" class="icon-left" symbol="true"></rs-icon>
            <span>Open knowledge map in draggable tab</span>
          </bs-menu-item>
        </mp-event-trigger>
        <hr>
      {{/case}}

      {{#case "http://www.researchspace.org/resource/system/resource_configurations_container/data/Set" break=true}}
      {{/case}}

      {{#case "http://www.researchspace.org/resource/system/resource_configurations_container/data/Set_item" break=true}}
      {{/case}}

      {{#default}}
        {{#if resourceEditorButton}}
        {{else}}
          <mp-overlay-dialog  id="{{viewId}}-resource-preview-dialog"  
                              type="modal" 
                              class="modal-xlSize preview_modal"
                              title="Preview">
            <mp-overlay-dialog-trigger>
              <bs-menu-item>
                <rs-icon icon-type="rounded" icon-name="fullscreen" class="icon-left" symbol="true"></rs-icon>
                <span>Preview</span>
              </bs-menu-item>
            </mp-overlay-dialog-trigger>

            <mp-overlay-dialog-content>
              <inline-template template-iri='[[resolvePrefix "rsp:ResourcePreview"]]' 
                                options='{  "resource": "{{iri}}", 
                                            "resourceConfig": "{{resourceConfig}}", 
                                            "resourceConfigLabel": "{{resourceLabel}}",
                                            {{#if resourceDescription}}"resourceDescription": "{{resourceDescription}}",{{/if}}
                                            "modalId": "{{viewId}}-resource-preview-dialog",
                                            "resourceDetailSection": true
                                          }' >
              </inline-template> 
            </mp-overlay-dialog-content>
          </mp-overlay-dialog>
          <hr>
        {{/if}}
      {{/default}}
    {{/switch}}

    {{#if (or (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Place") (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Organisation") )}}
      <semantic-if query='ASK { <{{iri}}> crm:P168_place_is_defined_by ?osm_geoCoordinates .
                                ?osm_geoCoordinates crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/osm_geographic_coordinates> .
                                ?osm_geoCoordinates crm:P190_has_symbolic_content ?wkt . }'>
        <template id='then'>
          <semantic-link-container uri='[[resolvePrefix "rsp:ThinkingFrames"]]'
                                    urlqueryparam-view='map' 
                                    urlqueryparam-resource='{{iri}}'>
            <bs-menu-item>
              <rs-icon icon-type="rounded" icon-name="place" class="icon-left" symbol="true"></rs-icon>
              <span>Open map</span>
            </bs-menu-item>
          </semantic-link-container>
        </template>
      </semantic-if>
      <semantic-if query='ASK { <{{iri}}> crm:P168_place_is_defined_by ?osm_geoCoordinates .
                                ?osm_geoCoordinates crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/osm_geographic_coordinates> .
                                ?osm_geoCoordinates crm:P190_has_symbolic_content ?wkt . }'>
        <template id='then'>
          <hr>
        </template>
      </semantic-if>
    {{/if}}

    {{#if (or (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Document") (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Authority_document") (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/3d_model"))}}
      <semantic-query query='SELECT ?file ?fileName ?fileMediaType WHERE {
                            BIND(<{{iri}}> as ?resource) .
                            
                            ?resource crmdig:L60i_is_documented_by ?digitizationProcess .
                            ?digitizationProcess a crmdig:D2_Digitization_Process .    
                            ?digitizationProcess crmdig:L11_had_output ?file .
                            ?file rs:PX_has_file_name ?fileName .
                            ?file rs:PX_has_media_type ?fileMediaType .
                          }'
                    template='{{> template}}'
        >
          <template id='template'>
            {{#ifCond bindings.0.fileMediaType.value "==" "application/pdf"}}
              <bs-menu-item href="/file?fileName={{bindings.0.fileName.value}}&storage=images&mode=open&mediaType=application%2Fpdf" target="_blank">
                <rs-icon icon-type="rounded" icon-name="open_in_new" class="icon-left" symbol="true"></rs-icon>
                <span>Open PDF document</span>
              </bs-menu-item>
            {{/ifCond}}
              <bs-menu-item>
                <rs-icon icon-type="rounded" icon-name="download" class="icon-left" symbol="true"></rs-icon>
                <mp-file-download post-action="" download-url="/file?storage=images&fileName={{encodeUriComponent bindings.0.fileName.value}}">
                  <span>Download file</span>
                </mp-file-download>
              </bs-menu-item>
            <hr>
          </template>
      </semantic-query>
    {{/if}}

    {{#if (or (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Image") (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Audio") (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Video"))}}
      <semantic-query query='SELECT ?file ?fileName ?fileMediaType WHERE {
                              BIND(<{{iri}}> as ?resource) .
                              
                              ?resource crmdig:L60i_is_documented_by ?digitizationProcess .
                              ?digitizationProcess a crmdig:D2_Digitization_Process .    
                              ?digitizationProcess crmdig:L11_had_output ?file .
                              ?file rs:PX_has_file_name ?fileName .
                              ?file rs:PX_has_media_type ?fileMediaType .
                            }'
                    template='{{> template}}'
        >
          <template id='template'>
            <bs-menu-item>
              <rs-icon icon-type="rounded" icon-name="download" class="icon-left" symbol="true"></rs-icon>
              <mp-file-download post-action="" download-url="/file?storage=images&fileName={{encodeUriComponent bindings.0.fileName.value}}">
                <span>Download file </span>
              </mp-file-download>
            </bs-menu-item>
            <hr>
          </template>
      </semantic-query>
    {{/if}}

    {{#if (or clipboardCard clipboardList)}}
    {{else}}
      <mp-copy-to-default-set id="{{viewId}}-copy-to-clipboard" resource="{{iri}}">
        <bs-menu-item>
          <rs-icon icon-type="rounded" icon-name="inventory" class="icon-left" symbol="true"></rs-icon>
          <span>Copy to clipboard</span>
        </bs-menu-item>
      </mp-copy-to-default-set>
    {{/if}}

    <mp-copy-to-clipboard text='{{iri}}' message='IRI has been copied'>
      <bs-menu-item>
        <rs-icon icon-type="rounded" icon-name="content_copy" class="icon-left" symbol="true"></rs-icon>
        <span>Copy IRI</span>
      </bs-menu-item>
    </mp-copy-to-clipboard>

    {{#if resourceEditorButton}}
    {{else}}
      <hr>

      <semantic-link-container  uri='http://www.researchspace.org/resource/ThinkingFrames'
                                urlqueryparam-view="resource-editor"
                                urlqueryparam-resource-iri='{{iri}}'>
        <bs-menu-item>
          <rs-icon icon-type="rounded" icon-name="edit_note" class="icon-left" symbol="true"></rs-icon>
          <span>Edit</span>
        </bs-menu-item>
      </semantic-link-container>

      <semantic-link-container  uri='http://www.researchspace.org/resource/ThinkingFrames'
                                urlqueryparam-view="resource-editor"
                                urlqueryparam-resource-iri='{{iri}}'
                                urlqueryparam-open-as-drag-and-drop='true'>
        <bs-menu-item>
          <rs-icon icon-type='rounded' icon-name='read_more' symbol='true' class="icon-left"></rs-icon>
          <span>Edit in draggable tab</span>
        </bs-menu-item>
      </semantic-link-container>
    {{/if}}

    {{#if (not (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Set"))}}
      <hr>
      <mp-event-trigger id='{{viewId}}-image-annotation-add-frame-trigger' 
                        type='Dashboard.AddFrame' 
                        data='{"resourceIri": "{{iri}}", 
                                "viewId": "object-image-observation", 
                                "objectIri": "{{iri}}",
                                "frameId": "{{viewId}}"}' 
                        targets='["thinking-frames"]'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="photo_size_select_large" class="icon-left" symbol="true"></rs-icon>
            <span>Image view / annotations</span>
          </bs-menu-item>
      </mp-event-trigger>
    {{/if}}

    {{#if (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Image")}}
      <semantic-link-container  uri='[[resolvePrefix "rsp:ThinkingFrames"]]'
                                urlqueryparam-view='image-graph-authoring' 
                                urlqueryparam-resource='{{iri}}'>
        <bs-menu-item>
          <rs-icon icon-type="rounded" icon-name="wallpaper" class="icon-left" symbol="true"></rs-icon>
          <span>Image graph authoring</span>
        </bs-menu-item>
      </semantic-link-container> 
    {{/if}}

    {{#if (not (eq resourceConfig "http://www.researchspace.org/resource/system/resource_configurations_container/data/Knowledge_map"))}}
      <hr>
      <semantic-link-container  uri='[[resolvePrefix "rsp:ThinkingFrames"]]'
                                urlqueryparam-view='knowledge-map' 
                                urlqueryparam-resource='{{iri}}'>
          <bs-menu-item>
            <rs-icon icon-type="rounded" icon-name="hub" class="icon-left" symbol="true"></rs-icon>
            <span>Open in Knowledge map</span>
          </bs-menu-item>
      </semantic-link-container>
    {{/if}}

    {{#if (or knowledgeMapCard cardInDragAndDropInput resourceEditorButton)}}
    {{else}}
      <hr>
      <bs-menu-item>
        <rs-icon icon-type="rounded" icon-name="delete" class="icon-left" symbol="true"></rs-icon>
        <span>Delete</span>
      </bs-menu-item>
    {{/if}}

    [[> deleteButton resourceFormIRI=resourceFormIRI]]

    [[#if customAction]]
      [[#block "customAction"]][[/block]]
    [[/if]]
    
  </bs-dropdown-menu>
</bs-dropdown>

         

[[!-- DELETE BUTTON TRIGGERS FORM AND LDP DELETE OF resourceIri --]]
[[#*inline "deleteButton"]]
 

  <mp-overlay-dialog show='{{#if delete}}true{{else}}false{{/if}}' 
                      id='{{viewId}}-delete-resource-dialog-{{iri}}' 
                      title="Delete {{resourceName}}" type="modal" bs-size="large">
    <mp-overlay-dialog-trigger>
      <bs-menu-item>
        <rs-icon icon-type="round" icon-name="delete" class="icon-left"></rs-icon>
        <span>Delete</span>
      </bs-menu-item>
    </mp-overlay-dialog-trigger>
    <mp-overlay-dialog-content>
      <div>
            
        <span>Are you sure you want to delete <strong><mp-label iri="{{iri}}"></mp-label></strong> ?</span>
      
        <semantic-query 
              query='
                SELECT DISTINCT ?resource ?label  
                WHERE {
                  ?resource ?p <{{iri}}> .
                  OPTIONAL {<{{iri}}> skos:prefLabel ?nodeLabel .}
                  OPTIONAL {<{{iri}}> rdfs:label ?nodeLabel .}
  
                  OPTIONAL {
                    ?resource rdfs:label ?label .
                  }
                  OPTIONAL {
                    ?resource skos:prefLabel ?label .
                  }
                }
              '
              template='{{> referredByTemplate}}'
          >
            <template id='referredByTemplate'>
              Some resources in the system link to it:
              <ul>
                {{#each bindings}}
                  <li>
                    <semantic-link iri='{{resource.value}}'>{{label.value}}</semantic-link>
                  </li>
                {{/each}}
              </ul>
            </template>
          </semantic-query>
        </div>
        <div>
            <div style="display:none;visibility:hidden">
              <inline-template template-iri='{{resourceFormIRI}}'
                                options='{  
                                            "viewId": "{{iri}}",
                                            "mode": "edit",
                                            "editable": true,
                                            "node": "{{iri}}"
                                }'>
              </inline-template> 
            </div>  
          </div> 
        
        <div class="form-btn-group">
          <mp-event-trigger id='{{iri}}-cancel-feature-removal' 
                            type='OverlayDialog.Close' 
                            targets='["{{viewId}}-delete-resource-dialog-{{iri}}"]'>
            <button class="btn btn-default">Cancel</button>
          </mp-event-trigger>
          <mp-event-trigger id='{{iri}}-confirm-entity-removal' 
                              type='Form.RemoveResource'                               
                              data='{"iri": "{{iri}}", "node": "{{iri}}"}' 
                              targets='["{{iri}}-vocab-form","{{iri}}-close-form-removal-dialog"]'>
            <button class="btn btn-action">Delete</button>
          </mp-event-trigger>  

    
  [[!--        [[#if assetForm]]
            <semantic-query query='SELECT ?node ?file ?viewId WHERE { 
                                    BIND("{{viewId}}" as ?viewId) . 
                                    BIND(<{{iri}}> AS ?node) . 
                                    <{{iri}}> crmdig:L60i_is_documented_by/crmdig:L11_had_output ?file . 
                                  } LIMIT 1' 
                            template='{{> deleteFileTemplate}}'>
              
              <template id='deleteFileTemplate'>
                <semantic-context repository='assets'>
                  <rs-file-remove id='{{bindings.0.viewId.value}}-file-removal-{{bindings.0.node.value}}' 
                                  iri='{{bindings.0.file.value}}' 
                                  storage='[[assetStorage]]'
                                  name-predicate-iri='http://www.researchspace.org/ontology/PX_has_file_name'
                                  media-type-predicate-iri='http://www.researchspace.org/ontology/PX_has_media_type'
                  >
                    <button class="btn btn-action">Delete</button>
                  </rs-file-remove>
                </semantic-context>
                
                <mp-event-proxy id='{{bindings.0.viewId.value}}-entity-removal' 
                                on-event-source='{{bindings.0.viewId.value}}-file-removal-{{bindings.0.node.value}}' 
                                on-event-type='File.Removed'
                                proxy-event-type='Form.RemoveResource' 
                                data='{"iri": "{{bindings.0.node.value}}"}' 
                                proxy-targets='["{{bindings.0.viewId.value}}-vocab-form"]'
                ></mp-event-proxy>
              </template>
            </semantic-query>
          [[else]]
            <mp-event-trigger id='{{iri}}-confirm-entity-removal' 
                              type='Form.RemoveResource'                               
                              data='{"iri": "{{iri}}", "node": "{{iri}}"}' 
                              targets='["{{iri}}-delete-form"]'>
              <button class="btn btn-action">Delete</button>
            </mp-event-trigger>  
            
          [[/if]]--]]
[[!--
          <mp-event-proxy id='{{viewId}}-update-form' 
                          on-event-source='{{viewId}}-vocab-form' 
                          on-event-type='Form.ResourceRemoved'
                          proxy-event-type='Component.TemplateUpdate'
                          proxy-targets='["{{viewId}}-term-forms", "{{viewId}}-resource-config-term-forms"]'
          ></mp-event-proxy> --]]

      </div>

      [[!-- Refresh Search page for that particular resource if open --]]
      <mp-event-proxy id='{{iri}}-refresh-search-page-{{viewId}}'
          on-event-source='{{iri}}-vocab-form' 
          on-event-type='Form.ResourceRemoved'         
          proxy-event-type='Component.TemplateUpdate' 
          proxy-targets='["{{viewId}}-resourceSearch-frame"]'
      </mp-event-proxy>

      [[!-- Close Delete dialog windown once form delete submitted --]]
      <mp-event-proxy id='{{iri}}-close-form-removal-dialog-{{viewId}}' 
          on-event-source='{{iri}}-vocab-form' 
          on-event-type='Form.ResourceRemoved'
          proxy-event-type='OverlayDialog.Close' 
          data='{}'
          proxy-targets='["{{viewId}}-delete-resource-dialog-{{iri}}"]'
      ></mp-event-proxy>      
    </mp-overlay-dialog-content>
  </mp-overlay-dialog>
[[/inline ]]