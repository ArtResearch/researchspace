[[!--
uses client-side templates:
[[> rsp:KnowledgeMapItemCard]]
--]]

<[[#if standalone]]ontodia[[else]]rs-ontodia-panel[[/if]] id='{{ontodiaVariable}}-ontodia' metadata='
<> a  <http://iflastandards.info/ns/fr/frbr/frbroo/F2_Expression> ;
       <http://www.cidoc-crm.org/cidoc-crm/P2_has_type> <http://www.researchspace.org/resource/system/vocab/resource_type/knowledge_map> .
  '
  image-iris='["http://www.researchspace.org/ontology/PX_has_main_representation"]'
  save-diagram-label="Save Map" settings=nostats post-saving=none add-to-default-set=true
  collapse-navigator=true
  request-links-on-init='{{#if miradorVariable}}true{{else}}{{#if diagram}}false{{else}}true{{/if}}{{/if}}'
  default-edge-style='{"editable": true}'
  edge-styles='{
    "http://www.researchspace.org/instances/fields/EntityhasConnection": {
      "editable": true,
      "linkStyle": {"connection": {"stroke-dasharray": "3"}}
    }
  }'


  [[#if (hasPermission "forms:ldp:*")]]
    [[#if readonly]]
      readonly='true'
    [[/if]]
  [[else]]
    readonly='true'
  [[/if]]

  diagram='{{#if diagram}}{{diagram}}{{/if}}' 
  iri='{{#if iri}}{{iri}}{{/if}}' 
  iris='{{#if iris}}{{iris}}{{/if}}'

  left-panel-initially-open=false 
  default-node-template="{{> default}}"    
  additional-tree-item-template='{{> additionalTreeItemTemplate}}'
  
  provider-settings='{ 
    "classTreeQuery": "
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
      PREFIX owl: <http://www.w3.org/2002/07/owl#>

      SELECT ?class ?label ?parent WHERE {
        GRAPH ?g {
          ?ontology a owl:Ontology .
          ?class a owl:Class .
          OPTIONAL {
          	?class rdfs:label ?label.
          }

          OPTIONAL {
          	?class rdfs:subClassOf ?p.
         	  ?p a owl:Class .
          }
          BIND(IF(BOUND(?p), ?p, ?ontology) AS ?parent)
        }
      }
    "
  }'>

	<ontodia-field-configuration 
                            [[#if (hasPermission "forms:ldp:*")]]
                              authoring-mode=true
                            [[else]]
                              authoring-mode=false
                            [[/if]]
                            
                            type-iri='http://www.w3.org/1999/02/22-rdf-syntax-ns#type'
                            default-label-iri='http://www.researchspace.org/pattern/system/entity/primary_appellation'
                            default-image-iri='http://www.researchspace.org/pattern/system/entity/main_image'
                            default-subject-template='/{{{{raw}}}}{{FIELD_VALUE_LOCAL_NAME http://www.w3.org/1999/02/22-rdf-syntax-ns#type}}{{{{/raw}}}}/{{{{raw}}}}{{UUID}}{{{{/raw}}}}'
                            force-datatype-fields='["http://www.researchspace.org/ontology/PX_has_video"]'
                            
                            persistence='{
                                "type": "sparql",
                                "targetInsertGraphIri": "http://www.researchspace.org/resource/g/data"
                            }'
> 
  
  <rs-ontodia-metadata-from-fields 
      fields-query='PREFIX field: <http://www.researchspace.org/resource/system/fields/>
                    SELECT DISTINCT ?field WHERE { 
                    #{
                   #   ?field a <http://www.researchspace.org/resource/system/fields/Field> . 
                    #  ?field  <http://www.researchspace.org/resource/system/fields/ontology> ?ontology .
                    #} UNION
                    { 
                      ?field a <http://www.researchspace.org/resource/system/fields/Field> . 
                      ?field  <http://www.researchspace.org/resource/system/fields/category> <http://www.researchspace.org/resource/system/category/image_annotation> . 
                      }  
										UNION {
            					VALUES (?value){(<http://www.cidoc-crm.org/cidoc-crm/P138i_has_representation>)
                            (<http://www.researchspace.org/pattern/system/entity/primary_appellation>)
                      			(<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>)
                      			(<http://www.researchspace.org/pattern/system/entity/main_image>)  
                            (<http://www.ics.forth.gr/isl/CRMdig/L49_is_primary_area_of>)
                            (<http://www.researchspace.org/pattern/system/image_annotation/boundingBox>)
                            (<http://www.w3.org/1999/02/22-rdf-syntax-ns#value>)
                            (<http://www.researchspace.org/pattern/system/image_annotation/viewport>)
                            (<http://www.researchspace.org/pattern/system/image_annotation/area_of_image>)}                                                   
											
            					BIND(?value as ?field)
          					} }'>
  </rs-ontodia-metadata-from-fields> 
   [[#> ontodia-entity-metadata ]][[/ontodia-entity-metadata]]  
    <ontodia-field-input-override for-field="label">
        <semantic-form-text-input></semantic-form-text-input>
      </ontodia-field-input-override>
    <ontodia-field-input-override for-field="http://www.researchspace.org/pattern/system/entity/main_image">
    <semantic-form-autocomplete-input for='http://www.researchspace.org/pattern/system/entity/main_image' 
      nested-form-templates='[ 
                                                {
                                                  "label": "Image",
                                                  "nestedForm": "{{{{raw}}}}
                                                                    {{> \"http://www.researchspace.org/resource/system/forms/Image\" nested=true editable=true mode=\"new\"}}
                                                                {{{{/raw}}}}"
                                                }
                                              ]'>
      </semantic-form-autocomplete-input>
    </ontodia-field-input-override>

</ontodia-field-configuration>

<template id="additionalTreeItemTemplate">
  <semantic-query template='{{> scopeNote}}' query='SELECT ?note WHERE { <{{iri}}> rdfs:comment ?note } LIMIT 1'
  >
    <template id='scopeNote'>
      <mp-popover title="Scope Note">
        <mp-popover-trigger placement="right" trigger='["click"]'>
          <rs-icon icon-type="round" icon-name="help" style='margin-left: 10px;'></rs-icon>
        </mp-popover-trigger>
        <mp-popover-content>
          <div style='height: 200px; width: 250px; overflow: auto;'>
            <p>{{bindings.0.note.value}}</p>
          </div>
        </mp-popover-content>
      </mp-popover>

    </template>
  </semantic-query>
</template>

<template id="default">
  [[!-- Don't add any other explicit style here, only width and height, style is overriden by the resizable component in the KM --]]
  <div class="rs-KM-card-container" style="width: 180px; height:230px">
        {{#> rsp:itemCardTemplate autosize=true cardMargin=0}}
          {{#*inline "customFooter"}}
            <span class="text-s">{{label}}</span>
          {{/inline}}

          {{#*inline "additionalActions"}}
            <mp-draggable iri='{{iri}}'>
              <div class="rs-default-card__hover-icon">
                  <button type="button" class="rs-button" title="Drag and drop the Item">
                    <i class="rs-icon rs-icon-drag_arrow"></i>
                  </button>
              </div>
            </mp-draggable>

            [[#if (hasPermission "forms:ldp:*")]]
              <div class="rs-default-card__hover-icon">
                <button type="button" name='edit' class="rs-button" title="Edit">
                  <rs-icon icon-type="round" icon-name="edit"></rs-icon>
                </button>
              </div>
              <div class="rs-default-card__hover-icon">
                <button type="button" name='delete' class="rs-button" title="Delete">
                  <rs-icon icon-type="round" icon-name="delete"></rs-icon>
                </button>
              </div>
            [[/if]]
          {{/inline}}
        {{/rsp:itemCardTemplate}}
      {{#if isExpanded }}
        {{#if props.[http://www.cidoc-crm.org/cidoc-crm/P3_has_note]}}
            <div class="rs-card-note-container">
              <div>
                <span>Note: </span>
                <span>{{props.[http://www.cidoc-crm.org/cidoc-crm/P3_has_note].values.0.value}}</span>
              </div>
            </div>
        {{/if}}
      {{/if}}
  </div>
</template>

</[[#if standalone]]ontodia[[else]]rs-ontodia-panel[[/if]]>
