<div class="page__section-container">
  <h5 style="margin: 0px 0 7px;">Search on Wikidata</h5>

  <semantic-search>
    <semantic-search-query-keyword  domain='<http://www.cidoc-crm.org/cidoc-crm/E53_Place>'
                                    placeholder="Search person"
                                    min-search-term-length=2
                                    tokenize-lucene-query=false
                                    escape-lucene-syntax=false
                                    debounce=1000
                                    debounce=500
                                    query=' SERVICE <https://query.wikidata.org/sparql> {
                                      ?wikiURI rdfs:label ?name .
                                      FILTER (lang(?name) = "en")
                                      OPTIONAL  { ?wikiURI wdt:P18 ?image . }
                                    
                                    
                                    
                                    PREFIX osm: <http://www.researchspace.org/resource/system/services/osm/>
                                            SELECT ?subject WHERE { 
                                              ?subject osm:q ?__token__ .
                                              ?subject osm:display_name ?placeName.
                                              ?subject osm:geotext ?geoText.
                                              ?subject osm:wikidata ?wikidataId .
                                            }'
    ></semantic-search-query-keyword>
    
    <semantic-search-result-holder>
      <div style="margin-top: 25px;">
        <semantic-search-result>
          <div class="personResultsTable">
            <semantic-context repository='osm-nominatim-search'>
              <semantic-table id='semantic-search-result-table'
                              query='SELECT DISTINCT ?subject ?placeName ?wikidataId ?geoText WHERE {
                                      BIND(?subject as ?iri) .
                                    } ORDER BY ?subject'

                              options='{"showFilter":false, "resultsPerPage":10}' 
                              column-configuration='[
                                      {"displayName": "Name", "cellTemplate": "{{> placeName}}" },
                                      {"displayName": "Description (from Wikidata)", "cellTemplate": "{{> wikidata}}"},
                                      {"displayName": "Image", "cellTemplate": "{{> images}}"},
                                      {"displayName": "Place", "cellTemplate": "{{> placeMap}}" },
                                      {"displayName": "Actions", "cellTemplate": "{{> actions}}" }
                                    ]'   
              >

                <template id='placeName'>
                  <div>
                    {{#if wikidataId.value}}
                    <a class="text-link-action" 
                        target="_blank" 
                        href="http://www.wikidata.org/entity/{{wikidataId.value}}"
                        title="http://www.wikidata.org/entity/{{wikidataId.value}}">
                      {{placeName.value}}
                    </a>
                    {{else}}
                      {{placeName.value}}
                    {{/if}}
                  </div>
                </template>

                <template id='wikidata'>
                  <div>
                    {{#if wikidataId.value}}
                      <semantic-context repository='default'>
                        <semantic-query query='
                                          PREFIX wikibase: <http://wikiba.se/ontology#>
                                          PREFIX bd: <http://www.bigdata.com/rdf#>
                                          PREFIX mwapi: <https://www.mediawiki.org/ontology#API/>
                                          PREFIX wdt: <http://www.wikidata.org/prop/direct/>
                                          PREFIX wd: <http://www.wikidata.org/entity/>
                                          PREFIX schema: <http://schema.org/>

                                          SELECT ?description WHERE { 
                                            SERVICE <https://query.wikidata.org/sparql> {  
                                              BIND(IRI(CONCAT(STR(wd:), "{{wikidataId.value}}")) AS ?osmPlace) .
                                              SERVICE wikibase:label { 
                                                bd:serviceParam wikibase:language "en". 
                                                ?osmPlace rdfs:label ?label .
                                                ?osmPlace schema:description ?description .
                                              }
                                            }
                                          }'
                                        >
                        </semantic-query>
                      </semantic-context>
                    {{/if}}
                  </div>
                </template>

                <template id='placeMap'>
                  <div style='height: 230px; width: 370px;'>
                    <semantic-context repository='default'>
                      <semantic-map query='SELECT ?wkt WHERE { BIND("{{geoText.value}}" AS ?wkt) }'
                                    tuple-template='<b style="color:#525156; padding-botto:5px;">{{placeName.value}}</b>
                                                    {{#if wikidataId.value}}
                                                      <div>
                                                        <a style="color:#396EFE;"
                                                            target="_blank" 
                                                            href="http://www.wikidata.org/entity/{{wikidataId.value}}"
                                                            title="http://www.wikidata.org/entity/{{wikidataId.value}}">
                                                          Open in wikidata
                                                        </a>
                                                      </div>
                                                    {{/if}}'>
                      </semantic-map>
                    </semantic-context>
                  </div>
                </template>

                <template id='images'>
                  <div>
                    {{#if wikidataId.value}}
                      <semantic-context repository='default'>
                        <semantic-query query='
                                          PREFIX wikibase: <http://wikiba.se/ontology#>
                                          PREFIX bd: <http://www.bigdata.com/rdf#>
                                          PREFIX mwapi: <https://www.mediawiki.org/ontology#API/>
                                          PREFIX wdt: <http://www.wikidata.org/prop/direct/>
                                          PREFIX wd: <http://www.wikidata.org/entity/>
                                          PREFIX schema: <http://schema.org/>

                                          SELECT (SAMPLE(?_image) AS ?image) WHERE { 
                                            SERVICE <https://query.wikidata.org/sparql> {  
                                              BIND(IRI(CONCAT(STR(wd:), "{{wikidataId.value}}")) AS ?osmPlaceURI) .
                                              ?osmPlaceURI wdt:P18 ?_image .
                                            }
                                          } LIMIT 1'

                                          template='{{> placeImage}}'
                                          >
                                            <template id='placeImage'>
                                              <div>
                                                <a href="[[decodeUriComponent '{{bindings.0.image.value}}']]"
                                                  title="[[decodeUriComponent '{{bindings.0.image.value}}']]"
                                                  target="_blank">
                                                  
                                                  <img src="[[decodeUriComponent '{{bindings.0.image.value}}']]" 
                                                      width="auto" height="180" style="max-width: 200px; object-fit: contain;">
                                                </a>
                                              </div>
                                              
                                          [[!--    <mp-resource-thumbnail iri='[[decodeUriComponent "{{bindings.0.image.value}}"]]' class=''>
                                                <mp-resource-thumbnail-fallback>
                                                    <div>No image available</div>
                                                </mp-resource-thumbnail-fallback>
                                            </mp-resource-thumbnail> --]]
                                            </template>
                                          </semantic-query>
                      </semantic-context>
                    {{/if}}
                  </div>
                </template>
                

                <template id='actions'>
                  <div>
                    {{#if wikidataId.value}}
                  
                      <semantic-context repository='default'>
                        <semantic-query query='
                                          PREFIX wikibase: <http://wikiba.se/ontology#>
                                          PREFIX bd: <http://www.bigdata.com/rdf#>
                                          PREFIX mwapi: <https://www.mediawiki.org/ontology#API/>
                                          PREFIX wdt: <http://www.wikidata.org/prop/direct/>
                                          PREFIX wd: <http://www.wikidata.org/entity/>
                                          PREFIX schema: <http://schema.org/>

                                          SELECT ?osmPlaceURI ?osmPlaceName ?placeLabel ?placeDescription ?osmGeoCoordinates (SAMPLE(?_image) AS ?placeImage) WHERE { 
                                            SERVICE <https://query.wikidata.org/sparql> {  
                                              BIND(IRI(CONCAT(STR(wd:), "{{wikidataId.value}}")) AS ?osmPlaceURI) .
                                              BIND("{{placeName.value}}" as ?osmPlaceName)
                                              BIND("{{geoText.value}}" as ?osmGeoCoordinates)

                                              OPTIONAL { ?osmPlaceURI wdt:P18 ?_image . }
                                              SERVICE wikibase:label { 
                                                bd:serviceParam wikibase:language "en". 
                                                ?osmPlaceURI rdfs:label ?placeLabel .
                                                ?osmPlaceURI schema:description ?placeDescription .
                                              }
                                            }
                                          } GROUP BY ?osmPlaceURI ?osmPlaceName ?placeLabel ?placeDescription ?osmGeoCoordinates'
                                        >
                          <template id='template'>
                            <mp-event-trigger id='{{viewId}}-select-osm-place-trigger' 
                                              type='osmPlaceSelect' 
                                              data='{"osmPlaceURI": "{{bindings.0.osmPlaceURI.value}}", 
                                                      "osmPlaceName": "{{bindings.0.osmPlaceName.value}}", 
                                                      "placeLabel": "{{bindings.0.placeLabel.value}}",
                                                      "placeDescription": "{{bindings.0.placeDescription.value}}",
                                                      "osmGeoCoordinates": "{{bindings.0.osmGeoCoordinates.value}}"
                                                    }' 
                                        >
                                        <button class="btn btn-action">Select</button>
                            </mp-event-trigger>
                          </template>
                        </semantic-query>
                      </semantic-context>
            
                    {{else}}
                      <mp-event-trigger id='{{viewId}}-select-osm-place-trigger' 
                                        type='osmPlaceSelect' 
                                        data='{"osmPlaceName": "{{placeName.value}}", 
                                              "osmGeoCoordinates": "{{geoText.value}}",
                                              {{#if scheme}}"scheme": "{{scheme}}",{{/if}}
                                              "viewId": "{{viewId}}"
                                              }' >
                                        <button class="btn btn-action">Select</button>
                      </mp-event-trigger>
                    {{/if}}
                  </div>
                </template>

              </semantic-table>
            </semantic-context>
          </div>
        </semantic-search-result>
      </div>
    </semantic-search-result-holder>
    
  </semantic-search>
</div>
